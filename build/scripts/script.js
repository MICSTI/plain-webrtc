var app=angular.module("plain-webrtc",["ui.router","ngMessages"]);app.constant("AppConfig",{"log.info":!0,"log.error":!0}),app.controller("AppCtrl",["$scope","LogSrv","SocketSrv","FocusSrv","WebRTCSrv",function(n,e,t,o,c){var i={username:null},r=null,a=null,l=function(n){r=n,t.sendMessage({to:r.id,topic:"call.offer",payload:{}}),a="call.outgoing"},s=function(){t.sendMessage({to:r.id,topic:"call.withdrawn",payload:{}}),r=null,a=null},u=function(){t.sendMessage({to:r.id,topic:"call.rejected",payload:{}}),r=null,a=null},d=function(){t.sendMessage({to:r.id,topic:"call.accepted",payload:{}}),a="call.accepted",c.setRemotePeer(r)},f=function(){t.sendMessage({to:r.id,topic:"call.hangup",payload:{}}),c.closeConnection()};t.connect(),n.isLoggedIn=function(){return null!==i.username},n.userObj={},n.login=function(o){o?(i.username=n.userObj.username,t.register(i.username)):e.error("Form not valid")},n.user=function(){return i},n.peers=function(){return t.getUsers()},n.getInfoMessage=function(){return a},n.getRemotePeer=function(){return r},n.callUser=l,n.withdrawCall=s,n.rejectCall=u,n.acceptCall=d,n.hangUp=f,n.isConnected=c.isConnected,o("username"),n.$on("call.offer",function(n,e){r=t.findUserById(e.from),a="call.incoming"}),n.$on("call.withdrawn",function(n,e){r=null,a=null}),n.$on("call.rejected",function(n,e){r=null,a=null}),n.$on("call.accepted",function(n,e){a="call.accepted",c.setRemotePeer(r),c.establishConnection({initiator:!0})}),n.$on("call.hangup",function(n,e){c.closeConnection()}),n.$on("webrtc.connected",function(e,t){n.$apply(function(){a=null}),o("chatMessage")}),n.$on("webrtc.disconnected",function(e,t){n.$apply(function(){a=null})})}]),angular.module("plain-webrtc").controller("RealTimeVideoController",["$scope",function(n){}]),angular.module("plain-webrtc").directive("realTimeVideo",function(){return{template:'<video class="video"></video>',restrict:"E",controller:"RealTimeVideoController",link:function(n,e,t){var o,c,i=e[0].querySelector("video");i.autoplay=!0,i.srcObject=null,i.onloadedmetadata=function(){o=this.videoWidth,c=this.videoHeight},n.$on("webrtc.connected",function(n,e){i.srcObject=e.stream})}}}),angular.module("plain-webrtc").factory("FocusSrv",["$timeout","$window",function(n,e){return function(t){n(function(){var n=e.document.getElementById(t);n&&n.focus()})}}]),angular.module("plain-webrtc").factory("LogSrv",["AppConfig",function(n){var e=function(){n["log.info"]&&console.log.apply(console,arguments)},t=function(){n["log.error"]&&console.error.apply(console,arguments)};return{info:e,error:t}}]),angular.module("plain-webrtc").factory("SocketSrv",["$rootScope","LogSrv",function(n,e){var t=null,o=[],c=null,i=function(e,o){t.on(e,function(){var e=arguments;n.$apply(function(){o.apply(t,e)})})},r=function(){t=io.connect(),e.info("Socket connected"),i("id",function(n){c=n}),i("users.update",function(n){a(n)}),i("msg",function(e){var t=e.topic;delete e.topic,n.$broadcast(t,e)})},a=function(n){o=n.filter(function(n){return n.id!==c})},l=function(n){t.emit("register",{username:n})},s=function(n){t.emit("msg",n)},u=function(n){var e=null;return o.forEach(function(t){t.id===n&&(e=t)}),e};return{connect:r,register:l,findUserById:u,sendMessage:s,getUsers:function(){return o}}}]),angular.module("plain-webrtc").factory("WebRTCSrv",["$rootScope","LogSrv","SocketSrv",function(n,e,t){var o=null,c=null,i=null,r=null,a={peerConnectionConfig:{iceServers:[{urls:["stun:23.21.150.121"]},{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:numb.viagenie.ca?transport=udp"],username:"michael.stifter@evolaris.net",credential:"15uFbuCxazKrMzog2WnM"},{urls:["turn:numb.viagenie.ca?transport=tcp"],username:"michael.stifter@evolaris.net",credential:"15uFbuCxazKrMzog2WnM"}]},peerConnectionConstraints:{optional:[{DtlsSrtpKeyAgreement:!0}]},userMediaConstraints:{audio:!0,video:{width:480,height:360}}},l=function(){i=new RTCPeerConnection(a.peerConnectionConfig,a.peerConnectionConstraints),e.info("--- peer connection created ---",a.peerConnectionConfig,a.peerConnectionConstraints),i.addStream(o),e.info("--- local stream added ---"),i.onaddstream=d,i.onremovestream=f,i.oniceconnectionstatechange=p,i.onicecandidate=function(n){n.candidate&&t.sendMessage({to:r.id,topic:"webrtc.candidate",payload:{label:n.candidate.sdpMLineIndex,id:n.candidate.sdpMid,candidate:n.candidate.candidate}})},i.ondatachannel=function(n){e.info("--- data channel received ---",n.channel)}},s=function(){e.info("--- creating offer ---"),i.createOffer().then(function(n){i.setLocalDescription(n),t.sendMessage({to:r.id,topic:"webrtc.offer",payload:n})}).catch(function(n){e.error("Failed to create offer",n)})},u=function(){e.info("--- creating answer ---"),i.createAnswer().then(function(n){i.setLocalDescription(n),t.sendMessage({to:r.id,topic:"webrtc.answer",payload:n})}).catch(function(n){e.error("failed to set local description",n)})},d=function(n){e.info("--- remote stream added ---"),n.stream.getTracks().forEach(function(n){e.info("REMOTE STREAM TRACK",n)}),c=n.stream},f=function(n){e.info("--- remote stream removed ---")},p=function(t){var o=(t.srcElement||t.target).iceConnectionState;switch(o){case"connected":e.info("--- connected ---"),n.$broadcast("webrtc.connected",{stream:c});break;case"closed":e.info("--- closed ---"),n.$broadcast("webrtc.disconnected");break;case"disconnected":e.info("--- disconnected ---"),n.$broadcast("webrtc.disconnected"),v();break;case"failed":e.error("--- failed ---",t),m();break;default:e.info("--- ICE connection state change ---",o)}},g=function(n){return new Promise(function(n,t){navigator.mediaDevices.getUserMedia(a.userMediaConstraints).then(function(t){o=t,e.info("--- got media access ---",a.userMediaConstraints),n(o)}).catch(function(n){e.error("Failed to obtain media access for options",a.userMediaConstraints,n),t(n)})})},m=function(){return new Promise(function(n,e){null===o&&n();var t=o.getTracks();t.forEach(function(n){n.stop()}),o=null,n()})},C=function(n){g().then(function(){t.sendMessage({to:r.id,topic:"webrtc.init",payload:{}}),l()}).catch(function(n){})},b=function(){null!==i&&i.close(),i=null,o=null,c=null},v=function(){null!==i&&(e.info("--- closing WebRTC connection ---"),m().then(function(){b(),h(null)}))},h=function(n){r=n},w=function(){return null!==i};return n.$on("webrtc.init",function(n,t){e.info("--- received WebRTC init ---"),g().then(function(){l(),s()}).catch(function(n){})}),n.$on("webrtc.offer",function(n,t){e.info("--- received offer ---",t),i.setRemoteDescription(new RTCSessionDescription(t.payload)).then(function(){e.info("--- set remote description ---"),u()}).catch(function(n){e.error("failed to set remote description",n)})}),n.$on("webrtc.answer",function(n,t){e.info("--- received answer ---",t),i.setRemoteDescription(new RTCSessionDescription(t.payload)).then(function(){e.info("--- set remote description ---")}).catch(function(n){e.error("failed to set remote description",n)})}),n.$on("webrtc.candidate",function(n,t){i.remoteDescription&&i.addIceCandidate(new RTCIceCandidate(t.payload)).then(function(){e.info("--- added ICE candidate ---")}).catch(function(n){e.error("failed to add ICE candidate",n)})}),{init:l,establishConnection:C,closeConnection:v,setRemotePeer:h,isConnected:w}}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnRyb2xsZXJzL3JlYWwtdGltZS12aWRlby5jb250cm9sbGVyLmpzIiwiZGlyZWN0aXZlcy92aWRlb0RpcmVjdGl2ZS5qcyIsInNlcnZpY2VzL2ZvY3VzLnNlcnZpY2UuanMiLCJzZXJ2aWNlcy9sb2cuc2VydmljZS5qcyIsInNlcnZpY2VzL3NvY2tldC5pby5jbGllbnQuc2VydmljZS5qcyIsInNlcnZpY2VzL3dlYnJ0Yy5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFwcCIsImFuZ3VsYXIiLCJtb2R1bGUiLCJjb25zdGFudCIsImxvZy5pbmZvIiwibG9nLmVycm9yIiwiY29udHJvbGxlciIsIiRzY29wZSIsIkxvZ1NydiIsIlNvY2tldFNydiIsIkZvY3VzU3J2IiwiV2ViUlRDU3J2IiwidXNlciIsInVzZXJuYW1lIiwicmVtb3RlUGVlciIsInVpTWVzc2FnZSIsImNhbGxVc2VyIiwiX3JlbW90ZVBlZXIiLCJzZW5kTWVzc2FnZSIsInRvIiwiaWQiLCJ0b3BpYyIsInBheWxvYWQiLCJ3aXRoZHJhd0NhbGwiLCJyZWplY3RDYWxsIiwiYWNjZXB0Q2FsbCIsInNldFJlbW90ZVBlZXIiLCJoYW5nVXAiLCJjbG9zZUNvbm5lY3Rpb24iLCJjb25uZWN0IiwiaXNMb2dnZWRJbiIsInVzZXJPYmoiLCJsb2dpbiIsImlzVmFsaWQiLCJyZWdpc3RlciIsImVycm9yIiwicGVlcnMiLCJnZXRVc2VycyIsImdldEluZm9NZXNzYWdlIiwiZ2V0UmVtb3RlUGVlciIsImlzQ29ubmVjdGVkIiwiJG9uIiwiZXZlbnQiLCJkYXRhIiwiZmluZFVzZXJCeUlkIiwiZnJvbSIsImVzdGFibGlzaENvbm5lY3Rpb24iLCJpbml0aWF0b3IiLCIkYXBwbHkiLCJkaXJlY3RpdmUiLCJ0ZW1wbGF0ZSIsInJlc3RyaWN0IiwibGluayIsInNjb3BlIiwiZWxlbWVudCIsImF0dHJzIiwidmlkZW9XaWR0aCIsInZpZGVvSGVpZ2h0IiwidmlkZW8iLCJxdWVyeVNlbGVjdG9yIiwiYXV0b3BsYXkiLCJzcmNPYmplY3QiLCJvbmxvYWRlZG1ldGFkYXRhIiwidGhpcyIsInN0cmVhbSIsImZhY3RvcnkiLCIkdGltZW91dCIsIiR3aW5kb3ciLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiZm9jdXMiLCJBcHBDb25maWciLCJsb2dJbmZvIiwiY29uc29sZSIsImxvZyIsImFwcGx5IiwiYXJndW1lbnRzIiwibG9nRXJyb3IiLCJpbmZvIiwiJHJvb3RTY29wZSIsInNvY2tldCIsInVzZXJzIiwib3duSWQiLCJvbiIsImV2ZW50TmFtZSIsImNhbGxiYWNrIiwiYXJncyIsImlvIiwicGFyc2VVc2VyQXJyYXkiLCIkYnJvYWRjYXN0IiwiX3VzZXJzIiwiZmlsdGVyIiwiZW1pdCIsIm1lc3NhZ2UiLCJmb3JFYWNoIiwidSIsImxvY2FsU3RyZWFtIiwicmVtb3RlU3RyZWFtIiwicGVlckNvbm5lY3Rpb24iLCJjb25maWciLCJwZWVyQ29ubmVjdGlvbkNvbmZpZyIsImljZVNlcnZlcnMiLCJ1cmxzIiwiY3JlZGVudGlhbCIsInBlZXJDb25uZWN0aW9uQ29uc3RyYWludHMiLCJvcHRpb25hbCIsIkR0bHNTcnRwS2V5QWdyZWVtZW50IiwidXNlck1lZGlhQ29uc3RyYWludHMiLCJhdWRpbyIsIndpZHRoIiwiaGVpZ2h0IiwiaW5pdCIsIlJUQ1BlZXJDb25uZWN0aW9uIiwiYWRkU3RyZWFtIiwib25hZGRzdHJlYW0iLCJoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZCIsIm9ucmVtb3Zlc3RyZWFtIiwiaGFuZGxlUmVtb3RlU3RyZWFtUmVtb3ZlZCIsIm9uaWNlY29ubmVjdGlvbnN0YXRlY2hhbmdlIiwiaGFuZGxlSWNlQ29ubmVjdGlvblN0YXRlQ2hhbmdlIiwib25pY2VjYW5kaWRhdGUiLCJjYW5kaWRhdGUiLCJsYWJlbCIsInNkcE1MaW5lSW5kZXgiLCJzZHBNaWQiLCJvbmRhdGFjaGFubmVsIiwiY2hhbm5lbCIsIm9mZmVyIiwiY3JlYXRlT2ZmZXIiLCJ0aGVuIiwic2Vzc2lvbkRlc2NyaXB0aW9uIiwic2V0TG9jYWxEZXNjcmlwdGlvbiIsImNhdGNoIiwiZXJyIiwiYW5zd2VyIiwiY3JlYXRlQW5zd2VyIiwiZ2V0VHJhY2tzIiwidHJhY2siLCJzdGF0ZSIsInNyY0VsZW1lbnQiLCJ0YXJnZXQiLCJpY2VDb25uZWN0aW9uU3RhdGUiLCJjbG9zZVdlYlJUQ0Nvbm5lY3Rpb24iLCJyZWxlYXNlTWVkaWFBY2Nlc3MiLCJyZXF1ZXN0TWVkaWFBY2Nlc3MiLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJuYXZpZ2F0b3IiLCJtZWRpYURldmljZXMiLCJnZXRVc2VyTWVkaWEiLCJtZWRpYVN0cmVhbSIsInRyYWNrcyIsInN0b3AiLCJoYW5ndXAiLCJjbG9zZSIsInBlZXIiLCJzZXRSZW1vdGVEZXNjcmlwdGlvbiIsIlJUQ1Nlc3Npb25EZXNjcmlwdGlvbiIsInJlbW90ZURlc2NyaXB0aW9uIiwiYWRkSWNlQ2FuZGlkYXRlIiwiUlRDSWNlQ2FuZGlkYXRlIl0sIm1hcHBpbmdzIjoiQUFBQSxHQUFBQSxLQUFBQyxRQUFBQyxPQUFBLGdCQUNBLFlBQ0EsY0FJQUYsS0FBQUcsU0FBQSxhQUNBQyxZQUFBLEVBQ0FDLGFBQUEsSUFHQUwsSUFBQU0sV0FBQSxXQUFBLFNBQUEsU0FBQSxZQUFBLFdBQUEsWUFBQSxTQUFBQyxFQUFBQyxFQUFBQyxFQUFBQyxFQUFBQyxHQUVBLEdBQUFDLElBQ0FDLFNBQUEsTUFHQUMsRUFBQSxLQUNBQyxFQUFBLEtBRUFDLEVBQUEsU0FBQUMsR0FDQUgsRUFBQUcsRUFHQVIsRUFBQVMsYUFDQUMsR0FBQUwsRUFBQU0sR0FDQUMsTUFBQSxhQUNBQyxhQU1BUCxFQUFBLGlCQUdBUSxFQUFBLFdBRUFkLEVBQUFTLGFBQ0FDLEdBQUFMLEVBQUFNLEdBQ0FDLE1BQUEsaUJBQ0FDLGFBTUFSLEVBQUEsS0FHQUMsRUFBQSxNQUdBUyxFQUFBLFdBRUFmLEVBQUFTLGFBQ0FDLEdBQUFMLEVBQUFNLEdBQ0FDLE1BQUEsZ0JBQ0FDLGFBTUFSLEVBQUEsS0FHQUMsRUFBQSxN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QkFBQSxHQUFBQyxpQkFBQXZILEVBQUFyQixVQUNBMkcsS0FBQSxXQUNBekgsRUFBQXNFLEtBQUEsaUNBRUFzRCxNQUFBLFNBQUFDLEdBQ0E3SCxFQUFBMkIsTUFBQSw4QkFBQWtHLFFBTUF0QixLQUFBQSxFQUNBakUsb0JBQUFBLEVBQ0FsQixnQkFBQWtILEVBQ0FwSCxjQUFBQSxFQUNBYyxZQUFBQSIsImZpbGUiOiJzY3JpcHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoXCJwbGFpbi13ZWJydGNcIiwgW1xyXG4gICAgJ3VpLnJvdXRlcicsXHJcbiAgICAnbmdNZXNzYWdlcydcclxuXSk7XHJcblxyXG4vLyBkZWZpbmUgYXBwbGljYXRpb24gY29uc3RhbnRzXHJcbmFwcC5jb25zdGFudChcIkFwcENvbmZpZ1wiLCB7XHJcbiAgICBcImxvZy5pbmZvXCI6IHRydWUsXHJcbiAgICBcImxvZy5lcnJvclwiOiB0cnVlXHJcbn0pO1xyXG5cclxuYXBwLmNvbnRyb2xsZXIoXCJBcHBDdHJsXCIsIGZ1bmN0aW9uKCRzY29wZSwgTG9nU3J2LCBTb2NrZXRTcnYsIEZvY3VzU3J2LCBXZWJSVENTcnYpIHtcclxuICAgIC8vIC0tLS0tLS0tLS0tIEFwcCBjb25maWcgLS0tLS0tLS0tLS0tXHJcbiAgICB2YXIgdXNlciA9IHtcclxuICAgICAgICB1c2VybmFtZTogbnVsbFxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcmVtb3RlUGVlciA9IG51bGw7XHJcbiAgICB2YXIgdWlNZXNzYWdlID0gbnVsbDtcclxuXHJcbiAgICB2YXIgY2FsbFVzZXIgPSBmdW5jdGlvbihfcmVtb3RlUGVlcikge1xyXG4gICAgICAgIHJlbW90ZVBlZXIgPSBfcmVtb3RlUGVlcjtcclxuXHJcbiAgICAgICAgLy8gc2VuZCBjYWxsIG1lc3NhZ2UgdG8gcmVtb3RlIHBlZXJcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLm9mZmVyJyxcclxuICAgICAgICAgICAgcGF5bG9hZDoge1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBzZXQgVUkgbWVzc2FnZVxyXG4gICAgICAgIHVpTWVzc2FnZSA9ICdjYWxsLm91dGdvaW5nJztcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHdpdGhkcmF3Q2FsbCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLndpdGhkcmF3bicsXHJcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IFVJIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcmVqZWN0Q2FsbCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLnJlamVjdGVkJyxcclxuICAgICAgICAgICAgcGF5bG9hZDoge1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyByZXNldCByZW1vdGUgcGVlclxyXG4gICAgICAgIHJlbW90ZVBlZXIgPSBudWxsO1xyXG5cclxuICAgICAgICAvLyBzZXQgVUkgbWVzc2FnZVxyXG4gICAgICAgIHVpTWVzc2FnZSA9IG51bGw7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBhY2NlcHRDYWxsID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgLy8gc2VuZCBzb2NrZXQgbWVzc2FnZVxyXG4gICAgICAgIFNvY2tldFNydi5zZW5kTWVzc2FnZSh7XHJcbiAgICAgICAgICAgIHRvOiByZW1vdGVQZWVyLmlkLFxyXG4gICAgICAgICAgICB0b3BpYzogJ2NhbGwuYWNjZXB0ZWQnLFxyXG4gICAgICAgICAgICBwYXlsb2FkOiB7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIHNldCBVSSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gJ2NhbGwuYWNjZXB0ZWQnO1xyXG5cclxuICAgICAgICAvLyBzZXQgcmVtb3RlIHBlZXIgaW4gV2ViUlRDIHNlcnZpY2VcclxuICAgICAgICBXZWJSVENTcnYuc2V0UmVtb3RlUGVlcihyZW1vdGVQZWVyKTtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIGhhbmdVcCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLmhhbmd1cCcsXHJcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgV2ViUlRDU3J2LmNsb3NlQ29ubmVjdGlvbigpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyAtLS0tLS0tLS0tLSBBcHAgaW5pdGlhbGl6YXRpb24gLS0tLS0tLS0tLS0tXHJcbiAgICBTb2NrZXRTcnYuY29ubmVjdCgpO1xyXG5cclxuICAgIC8vIC0tLS0tLS0tLS0tIFNjb3BlIG1ldGhvZHMgLS0tLS0tLS0tLS0tXHJcbiAgICAkc2NvcGUuaXNMb2dnZWRJbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB1c2VyLnVzZXJuYW1lICE9PSBudWxsO1xyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUudXNlck9iaiA9IHt9O1xyXG5cclxuICAgICRzY29wZS5sb2dpbiA9IGZ1bmN0aW9uKGlzVmFsaWQpIHtcclxuICAgICAgICBpZiAoaXNWYWxpZCkge1xyXG4gICAgICAgICAgICB1c2VyLnVzZXJuYW1lID0gJHNjb3BlLnVzZXJPYmoudXNlcm5hbWU7XHJcblxyXG4gICAgICAgICAgICAvLyByZWdpc3RlciB1c2VybmFtZSB3aXRoIHNvY2tldCBzZXJ2aWNlXHJcbiAgICAgICAgICAgIFNvY2tldFNydi5yZWdpc3Rlcih1c2VyLnVzZXJuYW1lKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ0Zvcm0gbm90IHZhbGlkJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUudXNlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB1c2VyO1xyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUucGVlcnMgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gU29ja2V0U3J2LmdldFVzZXJzKCk7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5nZXRJbmZvTWVzc2FnZSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB1aU1lc3NhZ2U7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5nZXRSZW1vdGVQZWVyID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlbW90ZVBlZXI7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5jYWxsVXNlciA9IGNhbGxVc2VyO1xyXG4gICAgJHNjb3BlLndpdGhkcmF3Q2FsbCA9IHdpdGhkcmF3Q2FsbDtcclxuICAgICRzY29wZS5yZWplY3RDYWxsID0gcmVqZWN0Q2FsbDtcclxuICAgICRzY29wZS5hY2NlcHRDYWxsID0gYWNjZXB0Q2FsbDtcclxuICAgICRzY29wZS5oYW5nVXAgPSBoYW5nVXA7XHJcbiAgICAkc2NvcGUuaXNDb25uZWN0ZWQgPSBXZWJSVENTcnYuaXNDb25uZWN0ZWQ7XHJcblxyXG4gICAgRm9jdXNTcnYoJ3VzZXJuYW1lJyk7XHJcblxyXG5cclxuICAgIC8vIC0tLS0tLS0tLS0tIEV2ZW50IGhhbmRsaW5nIC0tLS0tLS0tLS0tLVxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5vZmZlcicsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gbG9vayB1cCB1c2VyXHJcbiAgICAgICAgcmVtb3RlUGVlciA9IFNvY2tldFNydi5maW5kVXNlckJ5SWQoZGF0YS5mcm9tKTtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSAnY2FsbC5pbmNvbWluZyc7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkc2NvcGUuJG9uKCdjYWxsLndpdGhkcmF3bicsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5yZWplY3RlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5hY2NlcHRlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSAnY2FsbC5hY2NlcHRlZCc7XHJcblxyXG4gICAgICAgIC8vIHNldCByZW1vdGUgcGVlciBpbiBXZWJSVEMgc2VydmljZVxyXG4gICAgICAgIFdlYlJUQ1Nydi5zZXRSZW1vdGVQZWVyKHJlbW90ZVBlZXIpO1xyXG5cclxuICAgICAgICAvLyBlc3RhYmxpc2ggV2ViUlRDIGNvbm5lY3Rpb25cclxuICAgICAgICBXZWJSVENTcnYuZXN0YWJsaXNoQ29ubmVjdGlvbih7XHJcbiAgICAgICAgICAgIGluaXRpYXRvcjogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5oYW5ndXAnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgIFdlYlJUQ1Nydi5jbG9zZUNvbm5lY3Rpb24oKTtcclxuICAgIH0pO1xyXG5cclxuICAgICRzY29wZS4kb24oJ3dlYnJ0Yy5jb25uZWN0ZWQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgICAgIHVpTWVzc2FnZSA9IG51bGw7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIEZvY3VzU3J2KCdjaGF0TWVzc2FnZScpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignd2VicnRjLmRpc2Nvbm5lY3RlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgICAgdWlNZXNzYWdlID0gbnVsbDtcclxuICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmFuZ3VsYXJcclxuICAgIC5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuY29udHJvbGxlcignUmVhbFRpbWVWaWRlb0NvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUpIHtcclxuXHJcbiAgICB9KTsiLCIndXNlIHN0cmljdCc7XHJcblxyXG5hbmd1bGFyXHJcbiAgICAubW9kdWxlKCdwbGFpbi13ZWJydGMnKVxyXG4gICAgLmRpcmVjdGl2ZSgncmVhbFRpbWVWaWRlbycsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRlbXBsYXRlOiAnPHZpZGVvIGNsYXNzPVwidmlkZW9cIj48L3ZpZGVvPicsXHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsXHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdSZWFsVGltZVZpZGVvQ29udHJvbGxlcicsXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIGxpbmsoc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdmlkZW8gPSBlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHZpZGVvV2lkdGgsIHZpZGVvSGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgICAgIHZpZGVvLmF1dG9wbGF5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHZpZGVvLnNyY09iamVjdCA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgdmlkZW8ub25sb2FkZWRtZXRhZGF0YSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZpZGVvV2lkdGggPSB0aGlzLnZpZGVvV2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlkZW9IZWlnaHQgPSB0aGlzLnZpZGVvSGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICBzY29wZS4kb24oJ3dlYnJ0Yy5jb25uZWN0ZWQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZpZGVvLnNyY09iamVjdCA9IGRhdGEuc3RyZWFtO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTsiLCIndXNlIHN0cmljdCc7XHJcblxyXG5hbmd1bGFyXHJcbiAgICAubW9kdWxlKCdwbGFpbi13ZWJydGMnKVxyXG4gICAgLmZhY3RvcnkoJ0ZvY3VzU3J2JywgZnVuY3Rpb24oJHRpbWVvdXQsICR3aW5kb3cpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgLy8gdGltZW91dCBtYWtlcyBzdXJlIHRoYXQgaXMgaW52b2tlZCBhZnRlciBhbnkgb3RoZXIgZXZlbnQgaGFzIGJlZW4gdHJpZ2dlcmVkLlxyXG4gICAgICAgICAgICAvLyBlLmcuIGNsaWNrIGV2ZW50cyB0aGF0IG5lZWQgdG8gcnVuIGJlZm9yZSB0aGUgZm9jdXMgb3JcclxuICAgICAgICAgICAgLy8gaW5wdXRzIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgZGlzYWJsZWQgc3RhdGUgYnV0IGFyZSBlbmFibGVkIHdoZW4gdGhvc2UgZXZlbnRzXHJcbiAgICAgICAgICAgIC8vIGFyZSB0cmlnZ2VyZWQuXHJcbiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSAkd2luZG93LmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmFuZ3VsYXJcclxuICAgIC5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuZmFjdG9yeSgnTG9nU3J2JywgZnVuY3Rpb24oQXBwQ29uZmlnKSB7XHJcbiAgICAgICAgdmFyIGxvZ0luZm8gPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKEFwcENvbmZpZ1tcImxvZy5pbmZvXCJdKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGxvZ0Vycm9yID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIGlmIChBcHBDb25maWdbXCJsb2cuZXJyb3JcIl0pIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IuYXBwbHkoY29uc29sZSwgYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGluZm86IGxvZ0luZm8sXHJcbiAgICAgICAgICAgIGVycm9yOiBsb2dFcnJvclxyXG4gICAgICAgIH07XHJcbiAgICB9KTsiLCIndXNlIHN0cmljdCc7XG5cbmFuZ3VsYXIubW9kdWxlKCdwbGFpbi13ZWJydGMnKVxuICAgIC5mYWN0b3J5KCdTb2NrZXRTcnYnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCBMb2dTcnYpIHtcbiAgICAgICAgdmFyIHNvY2tldCA9IG51bGw7XG4gICAgICAgIHZhciB1c2VycyA9IFtdO1xuICAgICAgICB2YXIgb3duSWQgPSBudWxsO1xuXG4gICAgICAgIHZhciBvbiA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHNvY2tldC5vbihldmVudE5hbWUsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzO1xuXG4gICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgZW1pdCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHNvY2tldC5lbWl0KGV2ZW50TmFtZSwgZGF0YSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7XG5cbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShzb2NrZXQsIGFyZ3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgY29ubmVjdCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgLy8gY29ubmVjdCB0byBTb2NrZXQuaW8gc2VydmVyXG4gICAgICAgICAgICBzb2NrZXQgPSBpby5jb25uZWN0KCk7XG5cbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKCdTb2NrZXQgY29ubmVjdGVkJyk7XG5cbiAgICAgICAgICAgIG9uKCdpZCcsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgICBvd25JZCA9IGRhdGE7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgb24oJ3VzZXJzLnVwZGF0ZScsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgICBwYXJzZVVzZXJBcnJheShkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBvbignbXNnJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIHZhciB0b3BpYyA9IGRhdGEudG9waWM7XG5cbiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS50b3BpYztcblxuICAgICAgICAgICAgICAgIC8vIHB1Ymxpc2ggcmVsYXkgbWVzc2FnZSBvbiByb290IHNjb3BlXG4gICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KHRvcGljLCBkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBwYXJzZVVzZXJBcnJheSA9IGZ1bmN0aW9uKF91c2Vycykge1xuICAgICAgICAgICAgdXNlcnMgPSBfdXNlcnMuZmlsdGVyKGZ1bmN0aW9uKHVzZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXNlci5pZCAhPT0gb3duSWQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgcmVnaXN0ZXIgPSBmdW5jdGlvbih1c2VybmFtZSkge1xuICAgICAgICAgICAgc29ja2V0LmVtaXQoJ3JlZ2lzdGVyJywge1xuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VybmFtZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHNlbmRNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkge1xuICAgICAgICAgICAgc29ja2V0LmVtaXQoJ21zZycsIG1lc3NhZ2UpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBmaW5kVXNlckJ5SWQgPSBmdW5jdGlvbihpZCkge1xuICAgICAgICAgICAgdmFyIHVzZXIgPSBudWxsO1xuXG4gICAgICAgICAgICB1c2Vycy5mb3JFYWNoKGZ1bmN0aW9uKHUpIHtcbiAgICAgICAgICAgICAgICBpZiAodS5pZCA9PT0gaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlciA9IHU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiB1c2VyO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb25uZWN0OiBjb25uZWN0LFxuICAgICAgICAgICAgcmVnaXN0ZXI6IHJlZ2lzdGVyLFxuICAgICAgICAgICAgZmluZFVzZXJCeUlkOiBmaW5kVXNlckJ5SWQsXG4gICAgICAgICAgICBzZW5kTWVzc2FnZTogc2VuZE1lc3NhZ2UsXG4gICAgICAgICAgICBnZXRVc2VyczogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVzZXJzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH0pO1xuIiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuYW5ndWxhci5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuZmFjdG9yeSgnV2ViUlRDU3J2JywgZnVuY3Rpb24oJHJvb3RTY29wZSwgTG9nU3J2LCBTb2NrZXRTcnYpIHtcclxuICAgICAgICB2YXIgbG9jYWxTdHJlYW0gPSBudWxsO1xyXG4gICAgICAgIHZhciByZW1vdGVTdHJlYW0gPSBudWxsO1xyXG4gICAgICAgIHZhciBwZWVyQ29ubmVjdGlvbiA9IG51bGw7XHJcblxyXG4gICAgICAgIHZhciByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gU2VydmljZSBjb25maWd1cmF0aW9uXHJcbiAgICAgICAgdmFyIGNvbmZpZyA9IHtcclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb25Db25maWc6IHtcclxuICAgICAgICAgICAgICAgIC8vIGRlZmF1bHQgSUNFIHNlcnZlciBjb25maWd1cmF0aW9uLCB3aWxsIGJlIG92ZXJ3cml0dGVuIGJ5IFhJUlNZUyBBUEkgcmVzcG9uc2VcclxuICAgICAgICAgICAgICAgIGljZVNlcnZlcnM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XCJ1cmxzXCI6IFtcInN0dW46MjMuMjEuMTUwLjEyMVwiXX0sXHJcbiAgICAgICAgICAgICAgICAgICAge1widXJsc1wiOiBbXCJzdHVuOnN0dW4ubC5nb29nbGUuY29tOjE5MzAyXCJdfSxcclxuICAgICAgICAgICAgICAgICAgICB7XCJ1cmxzXCI6IFtcInR1cm46bnVtYi52aWFnZW5pZS5jYT90cmFuc3BvcnQ9dWRwXCJdLCBcInVzZXJuYW1lXCI6IFwibWljaGFlbC5zdGlmdGVyQGV2b2xhcmlzLm5ldFwiLCBcImNyZWRlbnRpYWxcIjogXCIxNXVGYnVDeGF6S3JNem9nMlduTVwifSxcclxuICAgICAgICAgICAgICAgICAgICB7XCJ1cmxzXCI6IFtcInR1cm46bnVtYi52aWFnZW5pZS5jYT90cmFuc3BvcnQ9dGNwXCJdLCBcInVzZXJuYW1lXCI6IFwibWljaGFlbC5zdGlmdGVyQGV2b2xhcmlzLm5ldFwiLCBcImNyZWRlbnRpYWxcIjogXCIxNXVGYnVDeGF6S3JNem9nMlduTVwifVxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbkNvbnN0cmFpbnRzOiB7XHJcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcIkR0bHNTcnRwS2V5QWdyZWVtZW50XCI6IHRydWV9XHJcbiAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHVzZXJNZWRpYUNvbnN0cmFpbnRzOiB7XHJcbiAgICAgICAgICAgICAgICBhdWRpbzogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHZpZGVvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDQ4MCxcclxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDM2MFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24gPSBuZXcgUlRDUGVlckNvbm5lY3Rpb24oY29uZmlnLnBlZXJDb25uZWN0aW9uQ29uZmlnLCBjb25maWcucGVlckNvbm5lY3Rpb25Db25zdHJhaW50cyk7XHJcblxyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbyhcIi0tLSBwZWVyIGNvbm5lY3Rpb24gY3JlYXRlZCAtLS1cIiwgY29uZmlnLnBlZXJDb25uZWN0aW9uQ29uZmlnLCBjb25maWcucGVlckNvbm5lY3Rpb25Db25zdHJhaW50cyk7XHJcblxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5hZGRTdHJlYW0obG9jYWxTdHJlYW0pO1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGxvY2FsIHN0cmVhbSBhZGRlZCAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLm9uYWRkc3RyZWFtID0gaGFuZGxlUmVtb3RlU3RyZWFtQWRkZWQ7XHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLm9ucmVtb3Zlc3RyZWFtID0gaGFuZGxlUmVtb3RlU3RyZWFtUmVtb3ZlZDtcclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25pY2Vjb25uZWN0aW9uc3RhdGVjaGFuZ2UgPSBoYW5kbGVJY2VDb25uZWN0aW9uU3RhdGVDaGFuZ2U7XHJcblxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5vbmljZWNhbmRpZGF0ZSA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY2FuZGlkYXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgU29ja2V0U3J2LnNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG86IHJlbW90ZVBlZXIuaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljOiAnd2VicnRjLmNhbmRpZGF0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBldmVudC5jYW5kaWRhdGUuc2RwTUxpbmVJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBldmVudC5jYW5kaWRhdGUuc2RwTWlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlOiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLm9uZGF0YWNoYW5uZWwgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBkYXRhIGNoYW5uZWwgcmVjZWl2ZWQgLS0tJywgZXZlbnQuY2hhbm5lbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgb2ZmZXIgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBjcmVhdGluZyBvZmZlciAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmNyZWF0ZU9mZmVyKClcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHNlc3Npb25EZXNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLnNldExvY2FsRGVzY3JpcHRpb24oc2Vzc2lvbkRlc2NyaXB0aW9uKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgU29ja2V0U3J2LnNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG86IHJlbW90ZVBlZXIuaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljOiAnd2VicnRjLm9mZmVyJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogc2Vzc2lvbkRlc2NyaXB0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIG9mZmVyJywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBhbnN3ZXIgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBjcmVhdGluZyBhbnN3ZXIgLS0tJyk7XHJcblxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5jcmVhdGVBbnN3ZXIoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oc2Vzc2lvbkRlc2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uc2V0TG9jYWxEZXNjcmlwdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMuYW5zd2VyJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogc2Vzc2lvbkRlc2NyaXB0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5lcnJvcignZmFpbGVkIHRvIHNldCBsb2NhbCBkZXNjcmlwdGlvbicsIGVycik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgaGFuZGxlUmVtb3RlU3RyZWFtQWRkZWQgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbyhcIi0tLSByZW1vdGUgc3RyZWFtIGFkZGVkIC0tLVwiKTtcclxuXHJcbiAgICAgICAgICAgIGV2ZW50LnN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKGZ1bmN0aW9uKHRyYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbyhcIlJFTU9URSBTVFJFQU0gVFJBQ0tcIiwgdHJhY2spO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIHNhdmUgcmVtb3RlIHN0cmVhbSByZWZlcmVuY2VcclxuICAgICAgICAgICAgcmVtb3RlU3RyZWFtID0gZXZlbnQuc3RyZWFtO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBoYW5kbGVSZW1vdGVTdHJlYW1SZW1vdmVkID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICAgICAgTG9nU3J2LmluZm8oXCItLS0gcmVtb3RlIHN0cmVhbSByZW1vdmVkIC0tLVwiKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgaGFuZGxlSWNlQ29ubmVjdGlvblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICAgICAgdmFyIHN0YXRlID0gKGV2ZW50LnNyY0VsZW1lbnQgfHwgZXZlbnQudGFyZ2V0KS5pY2VDb25uZWN0aW9uU3RhdGU7ICAvLyBiZWNhdXNlIG9mIGRpZmZlcmVuY2VzIGJldHdlZW4gQ2hyb21lIGFuZCBGaXJlZm94XHJcblxyXG4gICAgICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdjb25uZWN0ZWQnOlxyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gY29ubmVjdGVkIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ3dlYnJ0Yy5jb25uZWN0ZWQnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbTogcmVtb3RlU3RyZWFtXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Nsb3NlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBjbG9zZWQgLS0tJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnd2VicnRjLmRpc2Nvbm5lY3RlZCcpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdkaXNjb25uZWN0ZWQnOlxyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gZGlzY29ubmVjdGVkIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ3dlYnJ0Yy5kaXNjb25uZWN0ZWQnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VXZWJSVENDb25uZWN0aW9uKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2ZhaWxlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCctLS0gZmFpbGVkIC0tLScsIGV2ZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gcmVsZWFzZSBtZWRpYSBhY2Nlc3MgKHJldHVybnMgYSBwcm9taXNlKVxyXG4gICAgICAgICAgICAgICAgICAgIHJlbGVhc2VNZWRpYUFjY2VzcygpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gSUNFIGNvbm5lY3Rpb24gc3RhdGUgY2hhbmdlIC0tLScsIHN0YXRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciByZXF1ZXN0TWVkaWFBY2Nlc3MgPSBmdW5jdGlvbihvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIG5hdmlnYXRvclxyXG4gICAgICAgICAgICAgICAgICAgIC5tZWRpYURldmljZXNcclxuICAgICAgICAgICAgICAgICAgICAuZ2V0VXNlck1lZGlhKGNvbmZpZy51c2VyTWVkaWFDb25zdHJhaW50cylcclxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihtZWRpYVN0cmVhbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0cmVhbSA9IG1lZGlhU3RyZWFtO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oXCItLS0gZ290IG1lZGlhIGFjY2VzcyAtLS1cIiwgY29uZmlnLnVzZXJNZWRpYUNvbnN0cmFpbnRzKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobG9jYWxTdHJlYW0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ0ZhaWxlZCB0byBvYnRhaW4gbWVkaWEgYWNjZXNzIGZvciBvcHRpb25zJywgY29uZmlnLnVzZXJNZWRpYUNvbnN0cmFpbnRzLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHJlbGVhc2VNZWRpYUFjY2VzcyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAvLyByZXNvbHZlIHByb21pc2UgaW1tZWRpYXRlbHkgaWYgbWVkaWEgYWNjZXNzIGhhcyBhbHJlYWR5IGJlZW4gcmVsZWFzZWRcclxuICAgICAgICAgICAgICAgIGlmIChsb2NhbFN0cmVhbSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgdHJhY2tzID0gbG9jYWxTdHJlYW0uZ2V0VHJhY2tzKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgdHJhY2tzLmZvckVhY2goZnVuY3Rpb24odHJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICB0cmFjay5zdG9wKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBsb2NhbFN0cmVhbSA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgZXN0YWJsaXNoQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgcmVxdWVzdE1lZGlhQWNjZXNzKClcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgaW5pdCBtZXNzYWdlIHRvIHJlbW90ZSBwZWVyXHJcbiAgICAgICAgICAgICAgICAgICAgU29ja2V0U3J2LnNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG86IHJlbW90ZVBlZXIuaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljOiAnd2VicnRjLmluaXQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGluaXQgcGVlciBjb25uZWN0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgaW5pdCgpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgaGFuZ3VwID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIGlmIChwZWVyQ29ubmVjdGlvbiAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24gPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgbG9jYWxTdHJlYW0gPSBudWxsO1xyXG4gICAgICAgICAgICByZW1vdGVTdHJlYW0gPSBudWxsO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBjbG9zZVdlYlJUQ0Nvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKHBlZXJDb25uZWN0aW9uICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNsb3NpbmcgV2ViUlRDIGNvbm5lY3Rpb24gLS0tJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVsZWFzZU1lZGlhQWNjZXNzKClcclxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZ3VwKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRSZW1vdGVQZWVyKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHNldFJlbW90ZVBlZXIgPSBmdW5jdGlvbihwZWVyKSB7XHJcbiAgICAgICAgICAgIHJlbW90ZVBlZXIgPSBwZWVyO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBpc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcGVlckNvbm5lY3Rpb24gIT09IG51bGw7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHJvb3RTY29wZS4kb24oJ3dlYnJ0Yy5pbml0JywgZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHtcclxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSByZWNlaXZlZCBXZWJSVEMgaW5pdCAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgIHJlcXVlc3RNZWRpYUFjY2VzcygpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpbml0IHBlZXIgY29ubmVjdGlvblxyXG4gICAgICAgICAgICAgICAgICAgIGluaXQoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBzZXNzaW9uIGRlc2NyaXB0aW9uIG9mZmVyXHJcbiAgICAgICAgICAgICAgICAgICAgb2ZmZXIoKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRyb290U2NvcGUuJG9uKCd3ZWJydGMub2ZmZXInLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIHJlY2VpdmVkIG9mZmVyIC0tLScsIGRhdGEpO1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihkYXRhLnBheWxvYWQpKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBzZXQgcmVtb3RlIGRlc2NyaXB0aW9uIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIGFuc3dlclxyXG4gICAgICAgICAgICAgICAgICAgIGFuc3dlcigpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ2ZhaWxlZCB0byBzZXQgcmVtb3RlIGRlc2NyaXB0aW9uJywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkcm9vdFNjb3BlLiRvbignd2VicnRjLmFuc3dlcicsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gcmVjZWl2ZWQgYW5zd2VyIC0tLScsIGRhdGEpO1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihkYXRhLnBheWxvYWQpKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBzZXQgcmVtb3RlIGRlc2NyaXB0aW9uIC0tLScpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ2ZhaWxlZCB0byBzZXQgcmVtb3RlIGRlc2NyaXB0aW9uJywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkcm9vdFNjb3BlLiRvbignd2VicnRjLmNhbmRpZGF0ZScsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgICAgIGlmIChwZWVyQ29ubmVjdGlvbi5yZW1vdGVEZXNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uYWRkSWNlQ2FuZGlkYXRlKG5ldyBSVENJY2VDYW5kaWRhdGUoZGF0YS5wYXlsb2FkKSlcclxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBhZGRlZCBJQ0UgY2FuZGlkYXRlIC0tLScpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ2ZhaWxlZCB0byBhZGQgSUNFIGNhbmRpZGF0ZScsIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaW5pdDogaW5pdCxcclxuICAgICAgICAgICAgZXN0YWJsaXNoQ29ubmVjdGlvbjogZXN0YWJsaXNoQ29ubmVjdGlvbixcclxuICAgICAgICAgICAgY2xvc2VDb25uZWN0aW9uOiBjbG9zZVdlYlJUQ0Nvbm5lY3Rpb24sXHJcbiAgICAgICAgICAgIHNldFJlbW90ZVBlZXI6IHNldFJlbW90ZVBlZXIsXHJcbiAgICAgICAgICAgIGlzQ29ubmVjdGVkOiBpc0Nvbm5lY3RlZFxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
