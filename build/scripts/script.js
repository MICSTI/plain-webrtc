var app=angular.module("plain-webrtc",["ui.router","ngMessages"]);app.constant("AppConfig",{"log.info":!0,"log.error":!0}),app.controller("AppCtrl",["$scope","LogSrv","SocketSrv","FocusSrv","WebRTCSrv",function(e,n,t,o,i){var c={username:null},r=null,a=null,l=function(e){r=e,t.sendMessage({to:r.id,topic:"call.offer",payload:{}}),a="call.outgoing"},s=function(){t.sendMessage({to:r.id,topic:"call.withdrawn",payload:{}}),r=null,a=null},u=function(){t.sendMessage({to:r.id,topic:"call.rejected",payload:{}}),r=null,a=null},d=function(){t.sendMessage({to:r.id,topic:"call.accepted",payload:{}}),a="call.accepted",i.setRemotePeer(r)};t.connect(),e.isLoggedIn=function(){return null!==c.username},e.userObj={},e.login=function(o){o?(c.username=e.userObj.username,t.register(c.username)):n.error("Form not valid")},e.user=function(){return c},e.peers=function(){return t.getUsers()},e.getInfoMessage=function(){return a},e.getRemotePeer=function(){return r},e.callUser=l,e.withdrawCall=s,e.rejectCall=u,e.acceptCall=d,e.isConnected=i.isConnected,o("username"),e.$on("call.offer",function(e,n){r=t.findUserById(n.from),a="call.incoming"}),e.$on("call.withdrawn",function(e,n){r=null,a=null}),e.$on("call.rejected",function(e,n){r=null,a=null}),e.$on("call.accepted",function(e,n){a="call.accepted",i.setRemotePeer(r),i.establishConnection({initiator:!0})}),e.$on("webrtc.connected",function(n,t){e.$apply(function(){a=null})}),e.$on("webrtc.disconnected",function(e,n){})}]),angular.module("plain-webrtc").controller("RealTimeVideoController",["$scope",function(e){}]),angular.module("plain-webrtc").directive("realTimeVideo",function(){return{template:'<video class="video"></video>',restrict:"E",controller:"RealTimeVideoController",link:function(e,n,t){var o,i,c=n[0].querySelector("video");c.autoplay=!0,c.srcObject=null,c.onloadedmetadata=function(){o=this.videoWidth,i=this.videoHeight},e.$on("webrtc.connected",function(e,n){c.srcObject=n.stream})}}}),angular.module("plain-webrtc").factory("FocusSrv",["$timeout","$window",function(e,n){return function(t){e(function(){var e=n.document.getElementById(t);e&&e.focus()})}}]),angular.module("plain-webrtc").factory("LogSrv",["AppConfig",function(e){var n=function(){e["log.info"]&&console.log.apply(console,arguments)},t=function(){e["log.error"]&&console.error.apply(console,arguments)};return{info:n,error:t}}]),angular.module("plain-webrtc").factory("SocketSrv",["$rootScope","LogSrv",function(e,n){var t=null,o=[],i=null,c=function(n,o){t.on(n,function(){var n=arguments;e.$apply(function(){o.apply(t,n)})})},r=function(){t=io.connect(),n.info("Socket connected"),c("id",function(e){i=e}),c("users.update",function(e){a(e)}),c("msg",function(n){var t=n.topic;delete n.topic,e.$broadcast(t,n)})},a=function(e){o=e.filter(function(e){return e.id!==i})},l=function(e){t.emit("register",{username:e})},s=function(e){t.emit("msg",e)},u=function(e){var n=null;return o.forEach(function(t){t.id===e&&(n=t)}),n};return{connect:r,register:l,findUserById:u,sendMessage:s,getUsers:function(){return o}}}]),angular.module("plain-webrtc").factory("WebRTCSrv",["$rootScope","LogSrv","SocketSrv",function(e,n,t){var o=null,i=null,c=null,r=null,a={peerConnectionConfig:{iceServers:[{urls:["stun:23.21.150.121"]},{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:numb.viagenie.ca?transport=udp"],username:"michael.stifter@evolaris.net",credential:"15uFbuCxazKrMzog2WnM"},{urls:["turn:numb.viagenie.ca?transport=tcp"],username:"michael.stifter@evolaris.net",credential:"15uFbuCxazKrMzog2WnM"}]},peerConnectionConstraints:{optional:[{DtlsSrtpKeyAgreement:!0}]},userMediaConstraints:{audio:!0,video:{width:480,height:360}}},l=function(){c=new RTCPeerConnection(a.peerConnectionConfig,a.peerConnectionConstraints),n.info("--- peer connection created ---",a.peerConnectionConfig,a.peerConnectionConstraints),c.addStream(o),n.info("--- local stream added ---"),c.onaddstream=d,c.onremovestream=f,c.oniceconnectionstatechange=p,c.onicecandidate=function(e){e.candidate&&t.sendMessage({to:r.id,topic:"webrtc.candidate",payload:{label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}})},c.ondatachannel=function(e){n.info("--- data channel received ---",e.channel)}},s=function(){n.info("--- creating offer ---"),c.createOffer().then(function(e){c.setLocalDescription(e),t.sendMessage({to:r.id,topic:"webrtc.offer",payload:e})}).catch(function(e){n.error("Failed to create offer",e)})},u=function(){n.info("--- creating answer ---"),c.createAnswer().then(function(e){c.setLocalDescription(e),t.sendMessage({to:r.id,topic:"webrtc.answer",payload:e})}).catch(function(e){n.error("failed to set local description",e)})},d=function(e){n.info("--- remote stream added ---"),e.stream.getTracks().forEach(function(e){n.info("REMOTE STREAM TRACK",e)}),i=e.stream},f=function(e){n.info("--- remote stream removed ---")},p=function(t){var o=(t.srcElement||t.target).iceConnectionState;switch(o){case"connected":n.info("--- connected ---"),e.$broadcast("webrtc.connected",{stream:i});break;case"closed":n.info("--- closed ---");break;case"disconnected":n.info("--- disconnected ---"),e.$broadcast("webrtc.disconnected"),m();break;case"failed":n.error("--- failed ---",t),m();break;default:n.info("--- ICE connection state change ---",o)}},g=function(e){return new Promise(function(e,t){navigator.mediaDevices.getUserMedia(a.userMediaConstraints).then(function(t){o=t,n.info("--- got media access ---",a.userMediaConstraints),e(o)}).catch(function(e){n.error("Failed to obtain media access for options",a.userMediaConstraints,e),t(e)})})},m=function(){return new Promise(function(e,n){null===o&&e();var t=o.getTracks();t.forEach(function(e){e.stop()}),o=null,e()})},C=function(e){g().then(function(){t.sendMessage({to:r.id,topic:"webrtc.init",payload:{}}),l()}).catch(function(e){})},v=function(e){r=e},b=function(){return null!==c};return e.$on("webrtc.init",function(e,t){n.info("--- received WebRTC init ---"),g().then(function(){l(),s()}).catch(function(e){})}),e.$on("webrtc.offer",function(e,t){n.info("--- received offer ---",t),c.setRemoteDescription(new RTCSessionDescription(t.payload)).then(function(){n.info("--- set remote description ---"),u()}).catch(function(e){n.error("failed to set remote description",e)})}),e.$on("webrtc.answer",function(e,t){n.info("--- received answer ---",t),c.setRemoteDescription(new RTCSessionDescription(t.payload)).then(function(){n.info("--- set remote description ---")}).catch(function(e){n.error("failed to set remote description",e)})}),e.$on("webrtc.candidate",function(e,t){c.remoteDescription&&c.addIceCandidate(new RTCIceCandidate(t.payload)).then(function(){n.info("--- added ICE candidate ---")}).catch(function(e){n.error("failed to add ICE candidate",e)})}),{init:l,establishConnection:C,setRemotePeer:v,isConnected:b}}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnRyb2xsZXJzL3JlYWwtdGltZS12aWRlby5jb250cm9sbGVyLmpzIiwiZGlyZWN0aXZlcy92aWRlb0RpcmVjdGl2ZS5qcyIsInNlcnZpY2VzL2ZvY3VzLnNlcnZpY2UuanMiLCJzZXJ2aWNlcy9sb2cuc2VydmljZS5qcyIsInNlcnZpY2VzL3NvY2tldC5pby5jbGllbnQuc2VydmljZS5qcyIsInNlcnZpY2VzL3dlYnJ0Yy5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFwcCIsImFuZ3VsYXIiLCJtb2R1bGUiLCJjb25zdGFudCIsImxvZy5pbmZvIiwibG9nLmVycm9yIiwiY29udHJvbGxlciIsIiRzY29wZSIsIkxvZ1NydiIsIlNvY2tldFNydiIsIkZvY3VzU3J2IiwiV2ViUlRDU3J2IiwidXNlciIsInVzZXJuYW1lIiwicmVtb3RlUGVlciIsInVpTWVzc2FnZSIsImNhbGxVc2VyIiwiX3JlbW90ZVBlZXIiLCJzZW5kTWVzc2FnZSIsInRvIiwiaWQiLCJ0b3BpYyIsInBheWxvYWQiLCJ3aXRoZHJhd0NhbGwiLCJyZWplY3RDYWxsIiwiYWNjZXB0Q2FsbCIsInNldFJlbW90ZVBlZXIiLCJjb25uZWN0IiwiaXNMb2dnZWRJbiIsInVzZXJPYmoiLCJsb2dpbiIsImlzVmFsaWQiLCJyZWdpc3RlciIsImVycm9yIiwicGVlcnMiLCJnZXRVc2VycyIsImdldEluZm9NZXNzYWdlIiwiZ2V0UmVtb3RlUGVlciIsImlzQ29ubmVjdGVkIiwiJG9uIiwiZXZlbnQiLCJkYXRhIiwiZmluZFVzZXJCeUlkIiwiZnJvbSIsImVzdGFibGlzaENvbm5lY3Rpb24iLCJpbml0aWF0b3IiLCIkYXBwbHkiLCJkaXJlY3RpdmUiLCJ0ZW1wbGF0ZSIsInJlc3RyaWN0IiwibGluayIsInNjb3BlIiwiZWxlbWVudCIsImF0dHJzIiwidmlkZW9XaWR0aCIsInZpZGVvSGVpZ2h0IiwidmlkZW8iLCJxdWVyeVNlbGVjdG9yIiwiYXV0b3BsYXkiLCJzcmNPYmplY3QiLCJvbmxvYWRlZG1ldGFkYXRhIiwidGhpcyIsInN0cmVhbSIsImZhY3RvcnkiLCIkdGltZW91dCIsIiR3aW5kb3ciLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiZm9jdXMiLCJBcHBDb25maWciLCJsb2dJbmZvIiwiY29uc29sZSIsImxvZyIsImFwcGx5IiwiYXJndW1lbnRzIiwibG9nRXJyb3IiLCJpbmZvIiwiJHJvb3RTY29wZSIsInNvY2tldCIsInVzZXJzIiwib3duSWQiLCJvbiIsImV2ZW50TmFtZSIsImNhbGxiYWNrIiwiYXJncyIsImlvIiwicGFyc2VVc2VyQXJyYXkiLCIkYnJvYWRjYXN0IiwiX3VzZXJzIiwiZmlsdGVyIiwiZW1pdCIsIm1lc3NhZ2UiLCJmb3JFYWNoIiwidSIsImxvY2FsU3RyZWFtIiwicmVtb3RlU3RyZWFtIiwicGVlckNvbm5lY3Rpb24iLCJjb25maWciLCJwZWVyQ29ubmVjdGlvbkNvbmZpZyIsImljZVNlcnZlcnMiLCJ1cmxzIiwiY3JlZGVudGlhbCIsInBlZXJDb25uZWN0aW9uQ29uc3RyYWludHMiLCJvcHRpb25hbCIsIkR0bHNTcnRwS2V5QWdyZWVtZW50IiwidXNlck1lZGlhQ29uc3RyYWludHMiLCJhdWRpbyIsIndpZHRoIiwiaGVpZ2h0IiwiaW5pdCIsIlJUQ1BlZXJDb25uZWN0aW9uIiwiYWRkU3RyZWFtIiwib25hZGRzdHJlYW0iLCJoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZCIsIm9ucmVtb3Zlc3RyZWFtIiwiaGFuZGxlUmVtb3RlU3RyZWFtUmVtb3ZlZCIsIm9uaWNlY29ubmVjdGlvbnN0YXRlY2hhbmdlIiwiaGFuZGxlSWNlQ29ubmVjdGlvblN0YXRlQ2hhbmdlIiwib25pY2VjYW5kaWRhdGUiLCJjYW5kaWRhdGUiLCJsYWJlbCIsInNkcE1MaW5lSW5kZXgiLCJzZHBNaWQiLCJvbmRhdGFjaGFubmVsIiwiY2hhbm5lbCIsIm9mZmVyIiwiY3JlYXRlT2ZmZXIiLCJ0aGVuIiwic2Vzc2lvbkRlc2NyaXB0aW9uIiwic2V0TG9jYWxEZXNjcmlwdGlvbiIsImNhdGNoIiwiZXJyIiwiYW5zd2VyIiwiY3JlYXRlQW5zd2VyIiwiZ2V0VHJhY2tzIiwidHJhY2siLCJzdGF0ZSIsInNyY0VsZW1lbnQiLCJ0YXJnZXQiLCJpY2VDb25uZWN0aW9uU3RhdGUiLCJyZWxlYXNlTWVkaWFBY2Nlc3MiLCJyZXF1ZXN0TWVkaWFBY2Nlc3MiLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJuYXZpZ2F0b3IiLCJtZWRpYURldmljZXMiLCJnZXRVc2VyTWVkaWEiLCJtZWRpYVN0cmVhbSIsInRyYWNrcyIsInN0b3AiLCJwZWVyIiwic2V0UmVtb3RlRGVzY3JpcHRpb24iLCJSVENTZXNzaW9uRGVzY3JpcHRpb24iLCJyZW1vdGVEZXNjcmlwdGlvbiIsImFkZEljZUNhbmRpZGF0ZSIsIlJUQ0ljZUNhbmRpZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUEsR0FBQUEsS0FBQUMsUUFBQUMsT0FBQSxnQkFDQSxZQUNBLGNBSUFGLEtBQUFHLFNBQUEsYUFDQUMsWUFBQSxFQUNBQyxhQUFBLElBR0FMLElBQUFNLFdBQUEsV0FBQSxTQUFBLFNBQUEsWUFBQSxXQUFBLFlBQUEsU0FBQUMsRUFBQUMsRUFBQUMsRUFBQUMsRUFBQUMsR0FFQSxHQUFBQyxJQUNBQyxTQUFBLE1BR0FDLEVBQUEsS0FDQUMsRUFBQSxLQUVBQyxFQUFBLFNBQUFDLEdBQ0FILEVBQUFHLEVBR0FSLEVBQUFTLGFBQ0FDLEdBQUFMLEVBQUFNLEdBQ0FDLE1BQUEsYUFDQUMsYUFNQVAsRUFBQSxpQkFHQVEsRUFBQSxXQUVBZCxFQUFBUyxhQUNBQyxHQUFBTCxFQUFBTSxHQUNBQyxNQUFBLGlCQUNBQyxhQU1BUixFQUFBLEtBR0FDLEVBQUEsTUFHQVMsRUFBQSxXQUVBZixFQUFBUyxhQUNBQyxHQUFBTCxFQUFBTSxHQUNBQyxNQUFBLGdCQUNBQyxhQU1BUixFQUFBLEtBR0FDLEVBQUEsTUFHQVUsRUFBQSxXQUVBaEIsRUFBQVMsYUFDQUMsR0FBQUwsRUFBQU0sR0FDQUMsTUFBQSxnQkFDQUMsYUFNQVAsRUFB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QWQsS0FBQSxXQUVBbEIsSUFHQWdCLE1BRUFLLE1BQUEsU0FBQUMsUUFLQXRELEVBQUF0QyxJQUFBLGVBQUEsU0FBQUMsRUFBQUMsR0FDQWpDLEVBQUFvRSxLQUFBLHlCQUFBbkMsR0FFQXVELEVBQUF5RCxxQkFBQSxHQUFBQyx1QkFBQWpILEVBQUFuQixVQUNBeUcsS0FBQSxXQUNBdkgsRUFBQW9FLEtBQUEsa0NBR0F3RCxNQUVBRixNQUFBLFNBQUFDLEdBQ0EzSCxFQUFBeUIsTUFBQSxtQ0FBQWtHLE9BSUF0RCxFQUFBdEMsSUFBQSxnQkFBQSxTQUFBQyxFQUFBQyxHQUNBakMsRUFBQW9FLEtBQUEsMEJBQUFuQyxHQUVBdUQsRUFBQXlELHFCQUFBLEdBQUFDLHVCQUFBakgsRUFBQW5CLFVBQ0F5RyxLQUFBLFdBQ0F2SCxFQUFBb0UsS0FBQSxvQ0FFQXNELE1BQUEsU0FBQUMsR0FDQTNILEVBQUF5QixNQUFBLG1DQUFBa0csT0FJQXRELEVBQUF0QyxJQUFBLG1CQUFBLFNBQUFDLEVBQUFDLEdBQ0F1RCxFQUFBMkQsbUJBQ0EzRCxFQUFBNEQsZ0JBQUEsR0FBQUMsaUJBQUFwSCxFQUFBbkIsVUFDQXlHLEtBQUEsV0FDQXZILEVBQUFvRSxLQUFBLGlDQUVBc0QsTUFBQSxTQUFBQyxHQUNBM0gsRUFBQXlCLE1BQUEsOEJBQUFrRyxRQU1BdEIsS0FBQUEsRUFDQWpFLG9CQUFBQSxFQUNBbEIsY0FBQUEsRUFDQVksWUFBQUEiLCJmaWxlIjoic2NyaXB0LmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKFwicGxhaW4td2VicnRjXCIsIFtcclxuICAgICd1aS5yb3V0ZXInLFxyXG4gICAgJ25nTWVzc2FnZXMnXHJcbl0pO1xyXG5cclxuLy8gZGVmaW5lIGFwcGxpY2F0aW9uIGNvbnN0YW50c1xyXG5hcHAuY29uc3RhbnQoXCJBcHBDb25maWdcIiwge1xyXG4gICAgXCJsb2cuaW5mb1wiOiB0cnVlLFxyXG4gICAgXCJsb2cuZXJyb3JcIjogdHJ1ZVxyXG59KTtcclxuXHJcbmFwcC5jb250cm9sbGVyKFwiQXBwQ3RybFwiLCBmdW5jdGlvbigkc2NvcGUsIExvZ1NydiwgU29ja2V0U3J2LCBGb2N1c1NydiwgV2ViUlRDU3J2KSB7XHJcbiAgICAvLyAtLS0tLS0tLS0tLSBBcHAgY29uZmlnIC0tLS0tLS0tLS0tLVxyXG4gICAgdmFyIHVzZXIgPSB7XHJcbiAgICAgICAgdXNlcm5hbWU6IG51bGxcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHJlbW90ZVBlZXIgPSBudWxsO1xyXG4gICAgdmFyIHVpTWVzc2FnZSA9IG51bGw7XHJcblxyXG4gICAgdmFyIGNhbGxVc2VyID0gZnVuY3Rpb24oX3JlbW90ZVBlZXIpIHtcclxuICAgICAgICByZW1vdGVQZWVyID0gX3JlbW90ZVBlZXI7XHJcblxyXG4gICAgICAgIC8vIHNlbmQgY2FsbCBtZXNzYWdlIHRvIHJlbW90ZSBwZWVyXHJcbiAgICAgICAgU29ja2V0U3J2LnNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgdG86IHJlbW90ZVBlZXIuaWQsXHJcbiAgICAgICAgICAgIHRvcGljOiAnY2FsbC5vZmZlcicsXHJcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gc2V0IFVJIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSAnY2FsbC5vdXRnb2luZyc7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciB3aXRoZHJhd0NhbGwgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAvLyBzZW5kIHNvY2tldCBtZXNzYWdlXHJcbiAgICAgICAgU29ja2V0U3J2LnNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgdG86IHJlbW90ZVBlZXIuaWQsXHJcbiAgICAgICAgICAgIHRvcGljOiAnY2FsbC53aXRoZHJhd24nLFxyXG4gICAgICAgICAgICBwYXlsb2FkOiB7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIHJlc2V0IHJlbW90ZSBwZWVyXHJcbiAgICAgICAgcmVtb3RlUGVlciA9IG51bGw7XHJcblxyXG4gICAgICAgIC8vIHNldCBVSSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gbnVsbDtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHJlamVjdENhbGwgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAvLyBzZW5kIHNvY2tldCBtZXNzYWdlXHJcbiAgICAgICAgU29ja2V0U3J2LnNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgdG86IHJlbW90ZVBlZXIuaWQsXHJcbiAgICAgICAgICAgIHRvcGljOiAnY2FsbC5yZWplY3RlZCcsXHJcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IFVJIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgYWNjZXB0Q2FsbCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLmFjY2VwdGVkJyxcclxuICAgICAgICAgICAgcGF5bG9hZDoge1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBzZXQgVUkgbWVzc2FnZVxyXG4gICAgICAgIHVpTWVzc2FnZSA9ICdjYWxsLmFjY2VwdGVkJztcclxuXHJcbiAgICAgICAgLy8gc2V0IHJlbW90ZSBwZWVyIGluIFdlYlJUQyBzZXJ2aWNlXHJcbiAgICAgICAgV2ViUlRDU3J2LnNldFJlbW90ZVBlZXIocmVtb3RlUGVlcik7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIC0tLS0tLS0tLS0tIEFwcCBpbml0aWFsaXphdGlvbiAtLS0tLS0tLS0tLS1cclxuICAgIFNvY2tldFNydi5jb25uZWN0KCk7XHJcblxyXG4gICAgLy8gLS0tLS0tLS0tLS0gU2NvcGUgbWV0aG9kcyAtLS0tLS0tLS0tLS1cclxuICAgICRzY29wZS5pc0xvZ2dlZEluID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHVzZXIudXNlcm5hbWUgIT09IG51bGw7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS51c2VyT2JqID0ge307XHJcblxyXG4gICAgJHNjb3BlLmxvZ2luID0gZnVuY3Rpb24oaXNWYWxpZCkge1xyXG4gICAgICAgIGlmIChpc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgIHVzZXIudXNlcm5hbWUgPSAkc2NvcGUudXNlck9iai51c2VybmFtZTtcclxuXHJcbiAgICAgICAgICAgIC8vIHJlZ2lzdGVyIHVzZXJuYW1lIHdpdGggc29ja2V0IHNlcnZpY2VcclxuICAgICAgICAgICAgU29ja2V0U3J2LnJlZ2lzdGVyKHVzZXIudXNlcm5hbWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIExvZ1Nydi5lcnJvcignRm9ybSBub3QgdmFsaWQnKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS51c2VyID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHVzZXI7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5wZWVycyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiBTb2NrZXRTcnYuZ2V0VXNlcnMoKTtcclxuICAgIH07XHJcblxyXG4gICAgJHNjb3BlLmdldEluZm9NZXNzYWdlID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHVpTWVzc2FnZTtcclxuICAgIH07XHJcblxyXG4gICAgJHNjb3BlLmdldFJlbW90ZVBlZXIgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gcmVtb3RlUGVlcjtcclxuICAgIH07XHJcblxyXG4gICAgJHNjb3BlLmNhbGxVc2VyID0gY2FsbFVzZXI7XHJcbiAgICAkc2NvcGUud2l0aGRyYXdDYWxsID0gd2l0aGRyYXdDYWxsO1xyXG4gICAgJHNjb3BlLnJlamVjdENhbGwgPSByZWplY3RDYWxsO1xyXG4gICAgJHNjb3BlLmFjY2VwdENhbGwgPSBhY2NlcHRDYWxsO1xyXG4gICAgJHNjb3BlLmlzQ29ubmVjdGVkID0gV2ViUlRDU3J2LmlzQ29ubmVjdGVkO1xyXG5cclxuICAgIEZvY3VzU3J2KCd1c2VybmFtZScpO1xyXG5cclxuXHJcbiAgICAvLyAtLS0tLS0tLS0tLSBFdmVudCBoYW5kbGluZyAtLS0tLS0tLS0tLS1cclxuICAgICRzY29wZS4kb24oJ2NhbGwub2ZmZXInLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgIC8vIGxvb2sgdXAgdXNlclxyXG4gICAgICAgIHJlbW90ZVBlZXIgPSBTb2NrZXRTcnYuZmluZFVzZXJCeUlkKGRhdGEuZnJvbSk7XHJcblxyXG4gICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gJ2NhbGwuaW5jb21pbmcnO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC53aXRoZHJhd24nLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgIC8vIHJlc2V0IHJlbW90ZSBwZWVyXHJcbiAgICAgICAgcmVtb3RlUGVlciA9IG51bGw7XHJcblxyXG4gICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gbnVsbDtcclxuICAgIH0pO1xyXG5cclxuICAgICRzY29wZS4kb24oJ2NhbGwucmVqZWN0ZWQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgIC8vIHJlc2V0IHJlbW90ZSBwZWVyXHJcbiAgICAgICAgcmVtb3RlUGVlciA9IG51bGw7XHJcblxyXG4gICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gbnVsbDtcclxuICAgIH0pO1xyXG5cclxuICAgICRzY29wZS4kb24oJ2NhbGwuYWNjZXB0ZWQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gJ2NhbGwuYWNjZXB0ZWQnO1xyXG5cclxuICAgICAgICAvLyBzZXQgcmVtb3RlIHBlZXIgaW4gV2ViUlRDIHNlcnZpY2VcclxuICAgICAgICBXZWJSVENTcnYuc2V0UmVtb3RlUGVlcihyZW1vdGVQZWVyKTtcclxuXHJcbiAgICAgICAgLy8gZXN0YWJsaXNoIFdlYlJUQyBjb25uZWN0aW9uXHJcbiAgICAgICAgV2ViUlRDU3J2LmVzdGFibGlzaENvbm5lY3Rpb24oe1xyXG4gICAgICAgICAgICBpbml0aWF0b3I6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgICRzY29wZS4kb24oJ3dlYnJ0Yy5jb25uZWN0ZWQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgICAgIHVpTWVzc2FnZSA9IG51bGw7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkc2NvcGUuJG9uKCd3ZWJydGMuZGlzY29ubmVjdGVkJywgZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHtcclxuXHJcbiAgICB9KTtcclxufSk7IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuYW5ndWxhclxyXG4gICAgLm1vZHVsZSgncGxhaW4td2VicnRjJylcclxuICAgIC5jb250cm9sbGVyKCdSZWFsVGltZVZpZGVvQ29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSkge1xyXG5cclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmFuZ3VsYXJcclxuICAgIC5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuZGlyZWN0aXZlKCdyZWFsVGltZVZpZGVvJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdGVtcGxhdGU6ICc8dmlkZW8gY2xhc3M9XCJ2aWRlb1wiPjwvdmlkZW8+JyxcclxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJyxcclxuICAgICAgICAgICAgY29udHJvbGxlcjogJ1JlYWxUaW1lVmlkZW9Db250cm9sbGVyJyxcclxuICAgICAgICAgICAgbGluazogZnVuY3Rpb24gbGluayhzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcclxuICAgICAgICAgICAgICAgIHZhciB2aWRlbyA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcigndmlkZW8nKTtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgdmlkZW9XaWR0aCwgdmlkZW9IZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgdmlkZW8uYXV0b3BsYXkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdmlkZW8uc3JjT2JqZWN0ID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICB2aWRlby5vbmxvYWRlZG1ldGFkYXRhID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlkZW9XaWR0aCA9IHRoaXMudmlkZW9XaWR0aDtcclxuICAgICAgICAgICAgICAgICAgICB2aWRlb0hlaWdodCA9IHRoaXMudmlkZW9IZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIHNjb3BlLiRvbignd2VicnRjLmNvbm5lY3RlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlkZW8uc3JjT2JqZWN0ID0gZGF0YS5zdHJlYW07XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmFuZ3VsYXJcclxuICAgIC5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuZmFjdG9yeSgnRm9jdXNTcnYnLCBmdW5jdGlvbigkdGltZW91dCwgJHdpbmRvdykge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbihpZCkge1xyXG4gICAgICAgICAgICAvLyB0aW1lb3V0IG1ha2VzIHN1cmUgdGhhdCBpcyBpbnZva2VkIGFmdGVyIGFueSBvdGhlciBldmVudCBoYXMgYmVlbiB0cmlnZ2VyZWQuXHJcbiAgICAgICAgICAgIC8vIGUuZy4gY2xpY2sgZXZlbnRzIHRoYXQgbmVlZCB0byBydW4gYmVmb3JlIHRoZSBmb2N1cyBvclxyXG4gICAgICAgICAgICAvLyBpbnB1dHMgZWxlbWVudHMgdGhhdCBhcmUgaW4gYSBkaXNhYmxlZCBzdGF0ZSBidXQgYXJlIGVuYWJsZWQgd2hlbiB0aG9zZSBldmVudHNcclxuICAgICAgICAgICAgLy8gYXJlIHRyaWdnZXJlZC5cclxuICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9ICR3aW5kb3cuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfSk7IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuYW5ndWxhclxyXG4gICAgLm1vZHVsZSgncGxhaW4td2VicnRjJylcclxuICAgIC5mYWN0b3J5KCdMb2dTcnYnLCBmdW5jdGlvbihBcHBDb25maWcpIHtcclxuICAgICAgICB2YXIgbG9nSW5mbyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBpZiAoQXBwQ29uZmlnW1wibG9nLmluZm9cIl0pIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgbG9nRXJyb3IgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKEFwcENvbmZpZ1tcImxvZy5lcnJvclwiXSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvci5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaW5mbzogbG9nSW5mbyxcclxuICAgICAgICAgICAgZXJyb3I6IGxvZ0Vycm9yXHJcbiAgICAgICAgfTtcclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcblxuYW5ndWxhci5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXG4gICAgLmZhY3RvcnkoJ1NvY2tldFNydicsIGZ1bmN0aW9uKCRyb290U2NvcGUsIExvZ1Nydikge1xuICAgICAgICB2YXIgc29ja2V0ID0gbnVsbDtcbiAgICAgICAgdmFyIHVzZXJzID0gW107XG4gICAgICAgIHZhciBvd25JZCA9IG51bGw7XG5cbiAgICAgICAgdmFyIG9uID0gZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgc29ja2V0Lm9uKGV2ZW50TmFtZSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7XG5cbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoc29ja2V0LCBhcmdzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBlbWl0ID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgc29ja2V0LmVtaXQoZXZlbnROYW1lLCBkYXRhLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcblxuICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25uZWN0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAvLyBjb25uZWN0IHRvIFNvY2tldC5pbyBzZXJ2ZXJcbiAgICAgICAgICAgIHNvY2tldCA9IGlvLmNvbm5lY3QoKTtcblxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJ1NvY2tldCBjb25uZWN0ZWQnKTtcblxuICAgICAgICAgICAgb24oJ2lkJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIG93bklkID0gZGF0YTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBvbigndXNlcnMudXBkYXRlJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIHBhcnNlVXNlckFycmF5KGRhdGEpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG9uKCdtc2cnLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRvcGljID0gZGF0YS50b3BpYztcblxuICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRvcGljO1xuXG4gICAgICAgICAgICAgICAgLy8gcHVibGlzaCByZWxheSBtZXNzYWdlIG9uIHJvb3Qgc2NvcGVcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QodG9waWMsIGRhdGEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHBhcnNlVXNlckFycmF5ID0gZnVuY3Rpb24oX3VzZXJzKSB7XG4gICAgICAgICAgICB1c2VycyA9IF91c2Vycy5maWx0ZXIoZnVuY3Rpb24odXNlcikge1xuICAgICAgICAgICAgICAgIHJldHVybiB1c2VyLmlkICE9PSBvd25JZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciByZWdpc3RlciA9IGZ1bmN0aW9uKHVzZXJuYW1lKSB7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdCgncmVnaXN0ZXInLCB7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXJuYW1lXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdCgnbXNnJywgbWVzc2FnZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGZpbmRVc2VyQnlJZCA9IGZ1bmN0aW9uKGlkKSB7XG4gICAgICAgICAgICB2YXIgdXNlciA9IG51bGw7XG5cbiAgICAgICAgICAgIHVzZXJzLmZvckVhY2goZnVuY3Rpb24odSkge1xuICAgICAgICAgICAgICAgIGlmICh1LmlkID09PSBpZCkge1xuICAgICAgICAgICAgICAgICAgICB1c2VyID0gdTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIHVzZXI7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvbm5lY3Q6IGNvbm5lY3QsXG4gICAgICAgICAgICByZWdpc3RlcjogcmVnaXN0ZXIsXG4gICAgICAgICAgICBmaW5kVXNlckJ5SWQ6IGZpbmRVc2VyQnlJZCxcbiAgICAgICAgICAgIHNlbmRNZXNzYWdlOiBzZW5kTWVzc2FnZSxcbiAgICAgICAgICAgIGdldFVzZXJzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXNlcnM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSk7XG4iLCIndXNlIHN0cmljdCc7XHJcblxyXG5hbmd1bGFyLm1vZHVsZSgncGxhaW4td2VicnRjJylcclxuICAgIC5mYWN0b3J5KCdXZWJSVENTcnYnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCBMb2dTcnYsIFNvY2tldFNydikge1xyXG4gICAgICAgIHZhciBsb2NhbFN0cmVhbSA9IG51bGw7XHJcbiAgICAgICAgdmFyIHJlbW90ZVN0cmVhbSA9IG51bGw7XHJcbiAgICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gbnVsbDtcclxuXHJcbiAgICAgICAgdmFyIHJlbW90ZVBlZXIgPSBudWxsO1xyXG5cclxuICAgICAgICAvLyBTZXJ2aWNlIGNvbmZpZ3VyYXRpb25cclxuICAgICAgICB2YXIgY29uZmlnID0ge1xyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbkNvbmZpZzoge1xyXG4gICAgICAgICAgICAgICAgLy8gZGVmYXVsdCBJQ0Ugc2VydmVyIGNvbmZpZ3VyYXRpb24sIHdpbGwgYmUgb3ZlcndyaXR0ZW4gYnkgWElSU1lTIEFQSSByZXNwb25zZVxyXG4gICAgICAgICAgICAgICAgaWNlU2VydmVyczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcInVybHNcIjogW1wic3R1bjoyMy4yMS4xNTAuMTIxXCJdfSxcclxuICAgICAgICAgICAgICAgICAgICB7XCJ1cmxzXCI6IFtcInN0dW46c3R1bi5sLmdvb2dsZS5jb206MTkzMDJcIl19LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcInVybHNcIjogW1widHVybjpudW1iLnZpYWdlbmllLmNhP3RyYW5zcG9ydD11ZHBcIl0sIFwidXNlcm5hbWVcIjogXCJtaWNoYWVsLnN0aWZ0ZXJAZXZvbGFyaXMubmV0XCIsIFwiY3JlZGVudGlhbFwiOiBcIjE1dUZidUN4YXpLck16b2cyV25NXCJ9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcInVybHNcIjogW1widHVybjpudW1iLnZpYWdlbmllLmNhP3RyYW5zcG9ydD10Y3BcIl0sIFwidXNlcm5hbWVcIjogXCJtaWNoYWVsLnN0aWZ0ZXJAZXZvbGFyaXMubmV0XCIsIFwiY3JlZGVudGlhbFwiOiBcIjE1dUZidUN4YXpLck16b2cyV25NXCJ9XHJcbiAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uQ29uc3RyYWludHM6IHtcclxuICAgICAgICAgICAgICAgIG9wdGlvbmFsOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1wiRHRsc1NydHBLZXlBZ3JlZW1lbnRcIjogdHJ1ZX1cclxuICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdXNlck1lZGlhQ29uc3RyYWludHM6IHtcclxuICAgICAgICAgICAgICAgIGF1ZGlvOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgdmlkZW86IHtcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogNDgwLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogMzYwXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbihjb25maWcucGVlckNvbm5lY3Rpb25Db25maWcsIGNvbmZpZy5wZWVyQ29ubmVjdGlvbkNvbnN0cmFpbnRzKTtcclxuXHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKFwiLS0tIHBlZXIgY29ubmVjdGlvbiBjcmVhdGVkIC0tLVwiLCBjb25maWcucGVlckNvbm5lY3Rpb25Db25maWcsIGNvbmZpZy5wZWVyQ29ubmVjdGlvbkNvbnN0cmFpbnRzKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmFkZFN0cmVhbShsb2NhbFN0cmVhbSk7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gbG9jYWwgc3RyZWFtIGFkZGVkIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25hZGRzdHJlYW0gPSBoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZDtcclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25yZW1vdmVzdHJlYW0gPSBoYW5kbGVSZW1vdGVTdHJlYW1SZW1vdmVkO1xyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5vbmljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZSA9IGhhbmRsZUljZUNvbm5lY3Rpb25TdGF0ZUNoYW5nZTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLm9uaWNlY2FuZGlkYXRlID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC5jYW5kaWRhdGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMuY2FuZGlkYXRlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNTGluZUluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW5kaWRhdGU6IGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25kYXRhY2hhbm5lbCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGRhdGEgY2hhbm5lbCByZWNlaXZlZCAtLS0nLCBldmVudC5jaGFubmVsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBvZmZlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNyZWF0aW5nIG9mZmVyIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uY3JlYXRlT2ZmZXIoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oc2Vzc2lvbkRlc2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uc2V0TG9jYWxEZXNjcmlwdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMub2ZmZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiBzZXNzaW9uRGVzY3JpcHRpb25cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgb2ZmZXInLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGFuc3dlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNyZWF0aW5nIGFuc3dlciAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmNyZWF0ZUFuc3dlcigpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKHNlc3Npb25EZXNjcmlwdGlvbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIFNvY2tldFNydi5zZW5kTWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvOiByZW1vdGVQZWVyLmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3BpYzogJ3dlYnJ0Yy5hbnN3ZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiBzZXNzaW9uRGVzY3JpcHRpb25cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCdmYWlsZWQgdG8gc2V0IGxvY2FsIGRlc2NyaXB0aW9uJywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKFwiLS0tIHJlbW90ZSBzdHJlYW0gYWRkZWQgLS0tXCIpO1xyXG5cclxuICAgICAgICAgICAgZXZlbnQuc3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2goZnVuY3Rpb24odHJhY2spIHtcclxuICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKFwiUkVNT1RFIFNUUkVBTSBUUkFDS1wiLCB0cmFjayk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gc2F2ZSByZW1vdGUgc3RyZWFtIHJlZmVyZW5jZVxyXG4gICAgICAgICAgICByZW1vdGVTdHJlYW0gPSBldmVudC5zdHJlYW07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGhhbmRsZVJlbW90ZVN0cmVhbVJlbW92ZWQgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbyhcIi0tLSByZW1vdGUgc3RyZWFtIHJlbW92ZWQgLS0tXCIpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBoYW5kbGVJY2VDb25uZWN0aW9uU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgICB2YXIgc3RhdGUgPSAoZXZlbnQuc3JjRWxlbWVudCB8fCBldmVudC50YXJnZXQpLmljZUNvbm5lY3Rpb25TdGF0ZTsgIC8vIGJlY2F1c2Ugb2YgZGlmZmVyZW5jZXMgYmV0d2VlbiBDaHJvbWUgYW5kIEZpcmVmb3hcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoc3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Nvbm5lY3RlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBjb25uZWN0ZWQgLS0tJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnd2VicnRjLmNvbm5lY3RlZCcsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtOiByZW1vdGVTdHJlYW1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY2xvc2VkJzpcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNsb3NlZCAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnZGlzY29ubmVjdGVkJzpcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGRpc2Nvbm5lY3RlZCAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd3ZWJydGMuZGlzY29ubmVjdGVkJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlbGVhc2UgbWVkaWEgYWNjZXNzIChyZXR1cm5zIGEgcHJvbWlzZSlcclxuICAgICAgICAgICAgICAgICAgICByZWxlYXNlTWVkaWFBY2Nlc3MoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnZmFpbGVkJzpcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJy0tLSBmYWlsZWQgLS0tJywgZXZlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyByZWxlYXNlIG1lZGlhIGFjY2VzcyAocmV0dXJucyBhIHByb21pc2UpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVsZWFzZU1lZGlhQWNjZXNzKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBJQ0UgY29ubmVjdGlvbiBzdGF0ZSBjaGFuZ2UgLS0tJywgc3RhdGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHJlcXVlc3RNZWRpYUFjY2VzcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgbmF2aWdhdG9yXHJcbiAgICAgICAgICAgICAgICAgICAgLm1lZGlhRGV2aWNlc1xyXG4gICAgICAgICAgICAgICAgICAgIC5nZXRVc2VyTWVkaWEoY29uZmlnLnVzZXJNZWRpYUNvbnN0cmFpbnRzKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKG1lZGlhU3RyZWFtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RyZWFtID0gbWVkaWFTdHJlYW07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbyhcIi0tLSBnb3QgbWVkaWEgYWNjZXNzIC0tLVwiLCBjb25maWcudXNlck1lZGlhQ29uc3RyYWludHMpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShsb2NhbFN0cmVhbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1Nydi5lcnJvcignRmFpbGVkIHRvIG9idGFpbiBtZWRpYSBhY2Nlc3MgZm9yIG9wdGlvbnMnLCBjb25maWcudXNlck1lZGlhQ29uc3RyYWludHMsIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgcmVsZWFzZU1lZGlhQWNjZXNzID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIC8vIHJlc29sdmUgcHJvbWlzZSBpbW1lZGlhdGVseSBpZiBtZWRpYSBhY2Nlc3MgaGFzIGFscmVhZHkgYmVlbiByZWxlYXNlZFxyXG4gICAgICAgICAgICAgICAgaWYgKGxvY2FsU3RyZWFtID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHZhciB0cmFja3MgPSBsb2NhbFN0cmVhbS5nZXRUcmFja3MoKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0cmFja3MuZm9yRWFjaChmdW5jdGlvbih0cmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyYWNrLnN0b3AoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGxvY2FsU3RyZWFtID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBlc3RhYmxpc2hDb25uZWN0aW9uID0gZnVuY3Rpb24ob3B0aW9ucykge1xyXG4gICAgICAgICAgICByZXF1ZXN0TWVkaWFBY2Nlc3MoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBpbml0IG1lc3NhZ2UgdG8gcmVtb3RlIHBlZXJcclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMuaW5pdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW5pdCBwZWVyIGNvbm5lY3Rpb25cclxuICAgICAgICAgICAgICAgICAgICBpbml0KCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG5cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBzZXRSZW1vdGVQZWVyID0gZnVuY3Rpb24ocGVlcikge1xyXG4gICAgICAgICAgICByZW1vdGVQZWVyID0gcGVlcjtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgaXNDb25uZWN0ZWQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHBlZXJDb25uZWN0aW9uICE9PSBudWxsO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRyb290U2NvcGUuJG9uKCd3ZWJydGMuaW5pdCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gcmVjZWl2ZWQgV2ViUlRDIGluaXQgLS0tJyk7XHJcblxyXG4gICAgICAgICAgICByZXF1ZXN0TWVkaWFBY2Nlc3MoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW5pdCBwZWVyIGNvbm5lY3Rpb25cclxuICAgICAgICAgICAgICAgICAgICBpbml0KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgc2Vzc2lvbiBkZXNjcmlwdGlvbiBvZmZlclxyXG4gICAgICAgICAgICAgICAgICAgIG9mZmVyKCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG5cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkcm9vdFNjb3BlLiRvbignd2VicnRjLm9mZmVyJywgZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHtcclxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSByZWNlaXZlZCBvZmZlciAtLS0nLCBkYXRhKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24oZGF0YS5wYXlsb2FkKSlcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gc2V0IHJlbW90ZSBkZXNjcmlwdGlvbiAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBhbnN3ZXJcclxuICAgICAgICAgICAgICAgICAgICBhbnN3ZXIoKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCdmYWlsZWQgdG8gc2V0IHJlbW90ZSBkZXNjcmlwdGlvbicsIGVycik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHJvb3RTY29wZS4kb24oJ3dlYnJ0Yy5hbnN3ZXInLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIHJlY2VpdmVkIGFuc3dlciAtLS0nLCBkYXRhKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24oZGF0YS5wYXlsb2FkKSlcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gc2V0IHJlbW90ZSBkZXNjcmlwdGlvbiAtLS0nKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCdmYWlsZWQgdG8gc2V0IHJlbW90ZSBkZXNjcmlwdGlvbicsIGVycik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHJvb3RTY29wZS4kb24oJ3dlYnJ0Yy5jYW5kaWRhdGUnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAocGVlckNvbm5lY3Rpb24ucmVtb3RlRGVzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmFkZEljZUNhbmRpZGF0ZShuZXcgUlRDSWNlQ2FuZGlkYXRlKGRhdGEucGF5bG9hZCkpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gYWRkZWQgSUNFIGNhbmRpZGF0ZSAtLS0nKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCdmYWlsZWQgdG8gYWRkIElDRSBjYW5kaWRhdGUnLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGluaXQ6IGluaXQsXHJcbiAgICAgICAgICAgIGVzdGFibGlzaENvbm5lY3Rpb246IGVzdGFibGlzaENvbm5lY3Rpb24sXHJcbiAgICAgICAgICAgIHNldFJlbW90ZVBlZXI6IHNldFJlbW90ZVBlZXIsXHJcbiAgICAgICAgICAgIGlzQ29ubmVjdGVkOiBpc0Nvbm5lY3RlZFxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
