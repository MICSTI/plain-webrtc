var app=angular.module("plain-webrtc",["ui.router","ngMessages"]);app.constant("AppConfig",{"log.info":!0,"log.error":!0}),app.controller("AppCtrl",["$scope","LogSrv","SocketSrv","FocusSrv","WebRTCSrv",function(n,e,t,o,c){var i={username:null},r=null,a=null,l=function(n){r=n,t.sendMessage({to:r.id,topic:"call.offer",payload:{}}),a="call.outgoing"},s=function(){t.sendMessage({to:r.id,topic:"call.withdrawn",payload:{}}),r=null,a=null},u=function(){t.sendMessage({to:r.id,topic:"call.rejected",payload:{}}),r=null,a=null},d=function(){t.sendMessage({to:r.id,topic:"call.accepted",payload:{}}),a="call.accepted",c.setRemotePeer(r)},f=function(){t.sendMessage({to:r.id,topic:"call.hangup",payload:{}}),c.closeConnection()};t.connect(),n.isLoggedIn=function(){return null!==i.username},n.userObj={},n.login=function(o){o?(i.username=n.userObj.username,t.register(i.username)):e.error("Form not valid")},n.user=function(){return i},n.peers=function(){return t.getUsers()},n.getInfoMessage=function(){return a},n.getRemotePeer=function(){return r},n.callUser=l,n.withdrawCall=s,n.rejectCall=u,n.acceptCall=d,n.hangUp=f,n.isConnected=c.isConnected,o("username"),n.$on("call.offer",function(n,e){r=t.findUserById(e.from),a="call.incoming"}),n.$on("call.withdrawn",function(n,e){r=null,a=null}),n.$on("call.rejected",function(n,e){r=null,a=null}),n.$on("call.accepted",function(n,e){a="call.accepted",c.setRemotePeer(r),c.establishConnection({initiator:!0})}),n.$on("call.hangup",function(n,e){c.closeConnection()}),n.$on("webrtc.connected",function(e,t){n.$apply(function(){a=null})}),n.$on("webrtc.disconnected",function(e,t){n.$apply(function(){a=null})})}]),angular.module("plain-webrtc").controller("RealTimeVideoController",["$scope",function(n){}]),angular.module("plain-webrtc").directive("realTimeVideo",function(){return{template:'<video class="video"></video>',restrict:"E",controller:"RealTimeVideoController",link:function(n,e,t){var o,c,i=e[0].querySelector("video");i.autoplay=!0,i.srcObject=null,i.onloadedmetadata=function(){o=this.videoWidth,c=this.videoHeight},n.$on("webrtc.connected",function(n,e){i.srcObject=e.stream})}}}),angular.module("plain-webrtc").factory("FocusSrv",["$timeout","$window",function(n,e){return function(t){n(function(){var n=e.document.getElementById(t);n&&n.focus()})}}]),angular.module("plain-webrtc").factory("LogSrv",["AppConfig",function(n){var e=function(){n["log.info"]&&console.log.apply(console,arguments)},t=function(){n["log.error"]&&console.error.apply(console,arguments)};return{info:e,error:t}}]),angular.module("plain-webrtc").factory("SocketSrv",["$rootScope","LogSrv",function(n,e){var t=null,o=[],c=null,i=function(e,o){t.on(e,function(){var e=arguments;n.$apply(function(){o.apply(t,e)})})},r=function(){t=io.connect(),e.info("Socket connected"),i("id",function(n){c=n}),i("users.update",function(n){a(n)}),i("msg",function(e){var t=e.topic;delete e.topic,n.$broadcast(t,e)})},a=function(n){o=n.filter(function(n){return n.id!==c})},l=function(n){t.emit("register",{username:n})},s=function(n){t.emit("msg",n)},u=function(n){var e=null;return o.forEach(function(t){t.id===n&&(e=t)}),e};return{connect:r,register:l,findUserById:u,sendMessage:s,getUsers:function(){return o}}}]),angular.module("plain-webrtc").factory("WebRTCSrv",["$rootScope","LogSrv","SocketSrv",function(n,e,t){var o=null,c=null,i=null,r=null,a={peerConnectionConfig:{iceServers:[{urls:["stun:23.21.150.121"]},{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:numb.viagenie.ca?transport=udp"],username:"michael.stifter@evolaris.net",credential:"15uFbuCxazKrMzog2WnM"},{urls:["turn:numb.viagenie.ca?transport=tcp"],username:"michael.stifter@evolaris.net",credential:"15uFbuCxazKrMzog2WnM"}]},peerConnectionConstraints:{optional:[{DtlsSrtpKeyAgreement:!0}]},userMediaConstraints:{audio:!0,video:{width:480,height:360}}},l=function(){i=new RTCPeerConnection(a.peerConnectionConfig,a.peerConnectionConstraints),e.info("--- peer connection created ---",a.peerConnectionConfig,a.peerConnectionConstraints),i.addStream(o),e.info("--- local stream added ---"),i.onaddstream=d,i.onremovestream=f,i.oniceconnectionstatechange=p,i.onicecandidate=function(n){n.candidate&&t.sendMessage({to:r.id,topic:"webrtc.candidate",payload:{label:n.candidate.sdpMLineIndex,id:n.candidate.sdpMid,candidate:n.candidate.candidate}})},i.ondatachannel=function(n){e.info("--- data channel received ---",n.channel)}},s=function(){e.info("--- creating offer ---"),i.createOffer().then(function(n){i.setLocalDescription(n),t.sendMessage({to:r.id,topic:"webrtc.offer",payload:n})}).catch(function(n){e.error("Failed to create offer",n)})},u=function(){e.info("--- creating answer ---"),i.createAnswer().then(function(n){i.setLocalDescription(n),t.sendMessage({to:r.id,topic:"webrtc.answer",payload:n})}).catch(function(n){e.error("failed to set local description",n)})},d=function(n){e.info("--- remote stream added ---"),n.stream.getTracks().forEach(function(n){e.info("REMOTE STREAM TRACK",n)}),c=n.stream},f=function(n){e.info("--- remote stream removed ---")},p=function(t){var o=(t.srcElement||t.target).iceConnectionState;switch(o){case"connected":e.info("--- connected ---"),n.$broadcast("webrtc.connected",{stream:c});break;case"closed":e.info("--- closed ---"),n.$broadcast("webrtc.disconnected");break;case"disconnected":e.info("--- disconnected ---"),n.$broadcast("webrtc.disconnected"),v();break;case"failed":e.error("--- failed ---",t),m();break;default:e.info("--- ICE connection state change ---",o)}},g=function(n){return new Promise(function(n,t){navigator.mediaDevices.getUserMedia(a.userMediaConstraints).then(function(t){o=t,e.info("--- got media access ---",a.userMediaConstraints),n(o)}).catch(function(n){e.error("Failed to obtain media access for options",a.userMediaConstraints,n),t(n)})})},m=function(){return new Promise(function(n,e){null===o&&n();var t=o.getTracks();t.forEach(function(n){n.stop()}),o=null,n()})},C=function(n){g().then(function(){t.sendMessage({to:r.id,topic:"webrtc.init",payload:{}}),l()}).catch(function(n){})},b=function(){null!==i&&i.close(),i=null,o=null,c=null},v=function(){null!==i&&(e.info("--- closing WebRTC connection ---"),m().then(function(){b(),h(null)}))},h=function(n){r=n},w=function(){return null!==i};return n.$on("webrtc.init",function(n,t){e.info("--- received WebRTC init ---"),g().then(function(){l(),s()}).catch(function(n){})}),n.$on("webrtc.offer",function(n,t){e.info("--- received offer ---",t),i.setRemoteDescription(new RTCSessionDescription(t.payload)).then(function(){e.info("--- set remote description ---"),u()}).catch(function(n){e.error("failed to set remote description",n)})}),n.$on("webrtc.answer",function(n,t){e.info("--- received answer ---",t),i.setRemoteDescription(new RTCSessionDescription(t.payload)).then(function(){e.info("--- set remote description ---")}).catch(function(n){e.error("failed to set remote description",n)})}),n.$on("webrtc.candidate",function(n,t){i.remoteDescription&&i.addIceCandidate(new RTCIceCandidate(t.payload)).then(function(){e.info("--- added ICE candidate ---")}).catch(function(n){e.error("failed to add ICE candidate",n)})}),{init:l,establishConnection:C,closeConnection:v,setRemotePeer:h,isConnected:w}}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnRyb2xsZXJzL3JlYWwtdGltZS12aWRlby5jb250cm9sbGVyLmpzIiwiZGlyZWN0aXZlcy92aWRlb0RpcmVjdGl2ZS5qcyIsInNlcnZpY2VzL2ZvY3VzLnNlcnZpY2UuanMiLCJzZXJ2aWNlcy9sb2cuc2VydmljZS5qcyIsInNlcnZpY2VzL3NvY2tldC5pby5jbGllbnQuc2VydmljZS5qcyIsInNlcnZpY2VzL3dlYnJ0Yy5zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImFwcCIsImFuZ3VsYXIiLCJtb2R1bGUiLCJjb25zdGFudCIsImxvZy5pbmZvIiwibG9nLmVycm9yIiwiY29udHJvbGxlciIsIiRzY29wZSIsIkxvZ1NydiIsIlNvY2tldFNydiIsIkZvY3VzU3J2IiwiV2ViUlRDU3J2IiwidXNlciIsInVzZXJuYW1lIiwicmVtb3RlUGVlciIsInVpTWVzc2FnZSIsImNhbGxVc2VyIiwiX3JlbW90ZVBlZXIiLCJzZW5kTWVzc2FnZSIsInRvIiwiaWQiLCJ0b3BpYyIsInBheWxvYWQiLCJ3aXRoZHJhd0NhbGwiLCJyZWplY3RDYWxsIiwiYWNjZXB0Q2FsbCIsInNldFJlbW90ZVBlZXIiLCJoYW5nVXAiLCJjbG9zZUNvbm5lY3Rpb24iLCJjb25uZWN0IiwiaXNMb2dnZWRJbiIsInVzZXJPYmoiLCJsb2dpbiIsImlzVmFsaWQiLCJyZWdpc3RlciIsImVycm9yIiwicGVlcnMiLCJnZXRVc2VycyIsImdldEluZm9NZXNzYWdlIiwiZ2V0UmVtb3RlUGVlciIsImlzQ29ubmVjdGVkIiwiJG9uIiwiZXZlbnQiLCJkYXRhIiwiZmluZFVzZXJCeUlkIiwiZnJvbSIsImVzdGFibGlzaENvbm5lY3Rpb24iLCJpbml0aWF0b3IiLCIkYXBwbHkiLCJkaXJlY3RpdmUiLCJ0ZW1wbGF0ZSIsInJlc3RyaWN0IiwibGluayIsInNjb3BlIiwiZWxlbWVudCIsImF0dHJzIiwidmlkZW9XaWR0aCIsInZpZGVvSGVpZ2h0IiwidmlkZW8iLCJxdWVyeVNlbGVjdG9yIiwiYXV0b3BsYXkiLCJzcmNPYmplY3QiLCJvbmxvYWRlZG1ldGFkYXRhIiwidGhpcyIsInN0cmVhbSIsImZhY3RvcnkiLCIkdGltZW91dCIsIiR3aW5kb3ciLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwiZm9jdXMiLCJBcHBDb25maWciLCJsb2dJbmZvIiwiY29uc29sZSIsImxvZyIsImFwcGx5IiwiYXJndW1lbnRzIiwibG9nRXJyb3IiLCJpbmZvIiwiJHJvb3RTY29wZSIsInNvY2tldCIsInVzZXJzIiwib3duSWQiLCJvbiIsImV2ZW50TmFtZSIsImNhbGxiYWNrIiwiYXJncyIsImlvIiwicGFyc2VVc2VyQXJyYXkiLCIkYnJvYWRjYXN0IiwiX3VzZXJzIiwiZmlsdGVyIiwiZW1pdCIsIm1lc3NhZ2UiLCJmb3JFYWNoIiwidSIsImxvY2FsU3RyZWFtIiwicmVtb3RlU3RyZWFtIiwicGVlckNvbm5lY3Rpb24iLCJjb25maWciLCJwZWVyQ29ubmVjdGlvbkNvbmZpZyIsImljZVNlcnZlcnMiLCJ1cmxzIiwiY3JlZGVudGlhbCIsInBlZXJDb25uZWN0aW9uQ29uc3RyYWludHMiLCJvcHRpb25hbCIsIkR0bHNTcnRwS2V5QWdyZWVtZW50IiwidXNlck1lZGlhQ29uc3RyYWludHMiLCJhdWRpbyIsIndpZHRoIiwiaGVpZ2h0IiwiaW5pdCIsIlJUQ1BlZXJDb25uZWN0aW9uIiwiYWRkU3RyZWFtIiwib25hZGRzdHJlYW0iLCJoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZCIsIm9ucmVtb3Zlc3RyZWFtIiwiaGFuZGxlUmVtb3RlU3RyZWFtUmVtb3ZlZCIsIm9uaWNlY29ubmVjdGlvbnN0YXRlY2hhbmdlIiwiaGFuZGxlSWNlQ29ubmVjdGlvblN0YXRlQ2hhbmdlIiwib25pY2VjYW5kaWRhdGUiLCJjYW5kaWRhdGUiLCJsYWJlbCIsInNkcE1MaW5lSW5kZXgiLCJzZHBNaWQiLCJvbmRhdGFjaGFubmVsIiwiY2hhbm5lbCIsIm9mZmVyIiwiY3JlYXRlT2ZmZXIiLCJ0aGVuIiwic2Vzc2lvbkRlc2NyaXB0aW9uIiwic2V0TG9jYWxEZXNjcmlwdGlvbiIsImNhdGNoIiwiZXJyIiwiYW5zd2VyIiwiY3JlYXRlQW5zd2VyIiwiZ2V0VHJhY2tzIiwidHJhY2siLCJzdGF0ZSIsInNyY0VsZW1lbnQiLCJ0YXJnZXQiLCJpY2VDb25uZWN0aW9uU3RhdGUiLCJjbG9zZVdlYlJUQ0Nvbm5lY3Rpb24iLCJyZWxlYXNlTWVkaWFBY2Nlc3MiLCJyZXF1ZXN0TWVkaWFBY2Nlc3MiLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJuYXZpZ2F0b3IiLCJtZWRpYURldmljZXMiLCJnZXRVc2VyTWVkaWEiLCJtZWRpYVN0cmVhbSIsInRyYWNrcyIsInN0b3AiLCJoYW5ndXAiLCJjbG9zZSIsInBlZXIiLCJzZXRSZW1vdGVEZXNjcmlwdGlvbiIsIlJUQ1Nlc3Npb25EZXNjcmlwdGlvbiIsInJlbW90ZURlc2NyaXB0aW9uIiwiYWRkSWNlQ2FuZGlkYXRlIiwiUlRDSWNlQ2FuZGlkYXRlIl0sIm1hcHBpbmdzIjoiQUFBQSxHQUFBQSxLQUFBQyxRQUFBQyxPQUFBLGdCQUNBLFlBQ0EsY0FJQUYsS0FBQUcsU0FBQSxhQUNBQyxZQUFBLEVBQ0FDLGFBQUEsSUFHQUwsSUFBQU0sV0FBQSxXQUFBLFNBQUEsU0FBQSxZQUFBLFdBQUEsWUFBQSxTQUFBQyxFQUFBQyxFQUFBQyxFQUFBQyxFQUFBQyxHQUVBLEdBQUFDLElBQ0FDLFNBQUEsTUFHQUMsRUFBQSxLQUNBQyxFQUFBLEtBRUFDLEVBQUEsU0FBQUMsR0FDQUgsRUFBQUcsRUFHQVIsRUFBQVMsYUFDQUMsR0FBQUwsRUFBQU0sR0FDQUMsTUFBQSxhQUNBQyxhQU1BUCxFQUFBLGlCQUdBUSxFQUFBLFdBRUFkLEVBQUFTLGFBQ0FDLEdBQUFMLEVBQUFNLEdBQ0FDLE1BQUEsaUJBQ0FDLGFBTUFSLEVBQUEsS0FHQUMsRUFBQSxNQUdBUyxFQUFBLFdBRUFmLEVBQUFTLGFBQ0FDLEdBQUFMLEVBQUFNLEdBQ0FDLE1BQUEsZ0JBQ0FDLGFBTUFSLEVBQUEsS0FHQUMsRUFBQSxN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QkFBQXZILEVBQUFyQixVQUNBMkcsS0FBQSxXQUNBekgsRUFBQXNFLEtBQUEsaUNBRUFzRCxNQUFBLFNBQUFDLEdBQ0E3SCxFQUFBMkIsTUFBQSw4QkFBQWtHLFFBTUF0QixLQUFBQSxFQUNBakUsb0JBQUFBLEVBQ0FsQixnQkFBQWtILEVBQ0FwSCxjQUFBQSxFQUNBYyxZQUFBQSIsImZpbGUiOiJzY3JpcHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoXCJwbGFpbi13ZWJydGNcIiwgW1xyXG4gICAgJ3VpLnJvdXRlcicsXHJcbiAgICAnbmdNZXNzYWdlcydcclxuXSk7XHJcblxyXG4vLyBkZWZpbmUgYXBwbGljYXRpb24gY29uc3RhbnRzXHJcbmFwcC5jb25zdGFudChcIkFwcENvbmZpZ1wiLCB7XHJcbiAgICBcImxvZy5pbmZvXCI6IHRydWUsXHJcbiAgICBcImxvZy5lcnJvclwiOiB0cnVlXHJcbn0pO1xyXG5cclxuYXBwLmNvbnRyb2xsZXIoXCJBcHBDdHJsXCIsIGZ1bmN0aW9uKCRzY29wZSwgTG9nU3J2LCBTb2NrZXRTcnYsIEZvY3VzU3J2LCBXZWJSVENTcnYpIHtcclxuICAgIC8vIC0tLS0tLS0tLS0tIEFwcCBjb25maWcgLS0tLS0tLS0tLS0tXHJcbiAgICB2YXIgdXNlciA9IHtcclxuICAgICAgICB1c2VybmFtZTogbnVsbFxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcmVtb3RlUGVlciA9IG51bGw7XHJcbiAgICB2YXIgdWlNZXNzYWdlID0gbnVsbDtcclxuXHJcbiAgICB2YXIgY2FsbFVzZXIgPSBmdW5jdGlvbihfcmVtb3RlUGVlcikge1xyXG4gICAgICAgIHJlbW90ZVBlZXIgPSBfcmVtb3RlUGVlcjtcclxuXHJcbiAgICAgICAgLy8gc2VuZCBjYWxsIG1lc3NhZ2UgdG8gcmVtb3RlIHBlZXJcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLm9mZmVyJyxcclxuICAgICAgICAgICAgcGF5bG9hZDoge1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBzZXQgVUkgbWVzc2FnZVxyXG4gICAgICAgIHVpTWVzc2FnZSA9ICdjYWxsLm91dGdvaW5nJztcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHdpdGhkcmF3Q2FsbCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLndpdGhkcmF3bicsXHJcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IFVJIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcmVqZWN0Q2FsbCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLnJlamVjdGVkJyxcclxuICAgICAgICAgICAgcGF5bG9hZDoge1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyByZXNldCByZW1vdGUgcGVlclxyXG4gICAgICAgIHJlbW90ZVBlZXIgPSBudWxsO1xyXG5cclxuICAgICAgICAvLyBzZXQgVUkgbWVzc2FnZVxyXG4gICAgICAgIHVpTWVzc2FnZSA9IG51bGw7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBhY2NlcHRDYWxsID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgLy8gc2VuZCBzb2NrZXQgbWVzc2FnZVxyXG4gICAgICAgIFNvY2tldFNydi5zZW5kTWVzc2FnZSh7XHJcbiAgICAgICAgICAgIHRvOiByZW1vdGVQZWVyLmlkLFxyXG4gICAgICAgICAgICB0b3BpYzogJ2NhbGwuYWNjZXB0ZWQnLFxyXG4gICAgICAgICAgICBwYXlsb2FkOiB7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIHNldCBVSSBtZXNzYWdlXHJcbiAgICAgICAgdWlNZXNzYWdlID0gJ2NhbGwuYWNjZXB0ZWQnO1xyXG5cclxuICAgICAgICAvLyBzZXQgcmVtb3RlIHBlZXIgaW4gV2ViUlRDIHNlcnZpY2VcclxuICAgICAgICBXZWJSVENTcnYuc2V0UmVtb3RlUGVlcihyZW1vdGVQZWVyKTtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIGhhbmdVcCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHNlbmQgc29ja2V0IG1lc3NhZ2VcclxuICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgdG9waWM6ICdjYWxsLmhhbmd1cCcsXHJcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgV2ViUlRDU3J2LmNsb3NlQ29ubmVjdGlvbigpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyAtLS0tLS0tLS0tLSBBcHAgaW5pdGlhbGl6YXRpb24gLS0tLS0tLS0tLS0tXHJcbiAgICBTb2NrZXRTcnYuY29ubmVjdCgpO1xyXG5cclxuICAgIC8vIC0tLS0tLS0tLS0tIFNjb3BlIG1ldGhvZHMgLS0tLS0tLS0tLS0tXHJcbiAgICAkc2NvcGUuaXNMb2dnZWRJbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB1c2VyLnVzZXJuYW1lICE9PSBudWxsO1xyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUudXNlck9iaiA9IHt9O1xyXG5cclxuICAgICRzY29wZS5sb2dpbiA9IGZ1bmN0aW9uKGlzVmFsaWQpIHtcclxuICAgICAgICBpZiAoaXNWYWxpZCkge1xyXG4gICAgICAgICAgICB1c2VyLnVzZXJuYW1lID0gJHNjb3BlLnVzZXJPYmoudXNlcm5hbWU7XHJcblxyXG4gICAgICAgICAgICAvLyByZWdpc3RlciB1c2VybmFtZSB3aXRoIHNvY2tldCBzZXJ2aWNlXHJcbiAgICAgICAgICAgIFNvY2tldFNydi5yZWdpc3Rlcih1c2VyLnVzZXJuYW1lKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ0Zvcm0gbm90IHZhbGlkJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUudXNlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB1c2VyO1xyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUucGVlcnMgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gU29ja2V0U3J2LmdldFVzZXJzKCk7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5nZXRJbmZvTWVzc2FnZSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB1aU1lc3NhZ2U7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5nZXRSZW1vdGVQZWVyID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlbW90ZVBlZXI7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5jYWxsVXNlciA9IGNhbGxVc2VyO1xyXG4gICAgJHNjb3BlLndpdGhkcmF3Q2FsbCA9IHdpdGhkcmF3Q2FsbDtcclxuICAgICRzY29wZS5yZWplY3RDYWxsID0gcmVqZWN0Q2FsbDtcclxuICAgICRzY29wZS5hY2NlcHRDYWxsID0gYWNjZXB0Q2FsbDtcclxuICAgICRzY29wZS5oYW5nVXAgPSBoYW5nVXA7XHJcbiAgICAkc2NvcGUuaXNDb25uZWN0ZWQgPSBXZWJSVENTcnYuaXNDb25uZWN0ZWQ7XHJcblxyXG4gICAgRm9jdXNTcnYoJ3VzZXJuYW1lJyk7XHJcblxyXG5cclxuICAgIC8vIC0tLS0tLS0tLS0tIEV2ZW50IGhhbmRsaW5nIC0tLS0tLS0tLS0tLVxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5vZmZlcicsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gbG9vayB1cCB1c2VyXHJcbiAgICAgICAgcmVtb3RlUGVlciA9IFNvY2tldFNydi5maW5kVXNlckJ5SWQoZGF0YS5mcm9tKTtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSAnY2FsbC5pbmNvbWluZyc7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkc2NvcGUuJG9uKCdjYWxsLndpdGhkcmF3bicsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5yZWplY3RlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gcmVzZXQgcmVtb3RlIHBlZXJcclxuICAgICAgICByZW1vdGVQZWVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5hY2NlcHRlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICB1aU1lc3NhZ2UgPSAnY2FsbC5hY2NlcHRlZCc7XHJcblxyXG4gICAgICAgIC8vIHNldCByZW1vdGUgcGVlciBpbiBXZWJSVEMgc2VydmljZVxyXG4gICAgICAgIFdlYlJUQ1Nydi5zZXRSZW1vdGVQZWVyKHJlbW90ZVBlZXIpO1xyXG5cclxuICAgICAgICAvLyBlc3RhYmxpc2ggV2ViUlRDIGNvbm5lY3Rpb25cclxuICAgICAgICBXZWJSVENTcnYuZXN0YWJsaXNoQ29ubmVjdGlvbih7XHJcbiAgICAgICAgICAgIGluaXRpYXRvcjogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJHNjb3BlLiRvbignY2FsbC5oYW5ndXAnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgIFdlYlJUQ1Nydi5jbG9zZUNvbm5lY3Rpb24oKTtcclxuICAgIH0pO1xyXG5cclxuICAgICRzY29wZS4kb24oJ3dlYnJ0Yy5jb25uZWN0ZWQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIC8vIHNldCB1aSBtZXNzYWdlXHJcbiAgICAgICAgICAgIHVpTWVzc2FnZSA9IG51bGw7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkc2NvcGUuJG9uKCd3ZWJydGMuZGlzY29ubmVjdGVkJywgZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHtcclxuICAgICAgICRzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgLy8gc2V0IHVpIG1lc3NhZ2VcclxuICAgICAgICAgICB1aU1lc3NhZ2UgPSBudWxsO1xyXG4gICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuYW5ndWxhclxyXG4gICAgLm1vZHVsZSgncGxhaW4td2VicnRjJylcclxuICAgIC5jb250cm9sbGVyKCdSZWFsVGltZVZpZGVvQ29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSkge1xyXG5cclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmFuZ3VsYXJcclxuICAgIC5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuZGlyZWN0aXZlKCdyZWFsVGltZVZpZGVvJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdGVtcGxhdGU6ICc8dmlkZW8gY2xhc3M9XCJ2aWRlb1wiPjwvdmlkZW8+JyxcclxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJyxcclxuICAgICAgICAgICAgY29udHJvbGxlcjogJ1JlYWxUaW1lVmlkZW9Db250cm9sbGVyJyxcclxuICAgICAgICAgICAgbGluazogZnVuY3Rpb24gbGluayhzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcclxuICAgICAgICAgICAgICAgIHZhciB2aWRlbyA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcigndmlkZW8nKTtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgdmlkZW9XaWR0aCwgdmlkZW9IZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgdmlkZW8uYXV0b3BsYXkgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdmlkZW8uc3JjT2JqZWN0ID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICB2aWRlby5vbmxvYWRlZG1ldGFkYXRhID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlkZW9XaWR0aCA9IHRoaXMudmlkZW9XaWR0aDtcclxuICAgICAgICAgICAgICAgICAgICB2aWRlb0hlaWdodCA9IHRoaXMudmlkZW9IZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIHNjb3BlLiRvbignd2VicnRjLmNvbm5lY3RlZCcsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlkZW8uc3JjT2JqZWN0ID0gZGF0YS5zdHJlYW07XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcclxuXHJcbmFuZ3VsYXJcclxuICAgIC5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXHJcbiAgICAuZmFjdG9yeSgnRm9jdXNTcnYnLCBmdW5jdGlvbigkdGltZW91dCwgJHdpbmRvdykge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbihpZCkge1xyXG4gICAgICAgICAgICAvLyB0aW1lb3V0IG1ha2VzIHN1cmUgdGhhdCBpcyBpbnZva2VkIGFmdGVyIGFueSBvdGhlciBldmVudCBoYXMgYmVlbiB0cmlnZ2VyZWQuXHJcbiAgICAgICAgICAgIC8vIGUuZy4gY2xpY2sgZXZlbnRzIHRoYXQgbmVlZCB0byBydW4gYmVmb3JlIHRoZSBmb2N1cyBvclxyXG4gICAgICAgICAgICAvLyBpbnB1dHMgZWxlbWVudHMgdGhhdCBhcmUgaW4gYSBkaXNhYmxlZCBzdGF0ZSBidXQgYXJlIGVuYWJsZWQgd2hlbiB0aG9zZSBldmVudHNcclxuICAgICAgICAgICAgLy8gYXJlIHRyaWdnZXJlZC5cclxuICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9ICR3aW5kb3cuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG4gICAgfSk7IiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuYW5ndWxhclxyXG4gICAgLm1vZHVsZSgncGxhaW4td2VicnRjJylcclxuICAgIC5mYWN0b3J5KCdMb2dTcnYnLCBmdW5jdGlvbihBcHBDb25maWcpIHtcclxuICAgICAgICB2YXIgbG9nSW5mbyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBpZiAoQXBwQ29uZmlnW1wibG9nLmluZm9cIl0pIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgbG9nRXJyb3IgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKEFwcENvbmZpZ1tcImxvZy5lcnJvclwiXSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvci5hcHBseShjb25zb2xlLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgaW5mbzogbG9nSW5mbyxcclxuICAgICAgICAgICAgZXJyb3I6IGxvZ0Vycm9yXHJcbiAgICAgICAgfTtcclxuICAgIH0pOyIsIid1c2Ugc3RyaWN0JztcblxuYW5ndWxhci5tb2R1bGUoJ3BsYWluLXdlYnJ0YycpXG4gICAgLmZhY3RvcnkoJ1NvY2tldFNydicsIGZ1bmN0aW9uKCRyb290U2NvcGUsIExvZ1Nydikge1xuICAgICAgICB2YXIgc29ja2V0ID0gbnVsbDtcbiAgICAgICAgdmFyIHVzZXJzID0gW107XG4gICAgICAgIHZhciBvd25JZCA9IG51bGw7XG5cbiAgICAgICAgdmFyIG9uID0gZnVuY3Rpb24oZXZlbnROYW1lLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgc29ja2V0Lm9uKGV2ZW50TmFtZSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7XG5cbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoc29ja2V0LCBhcmdzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBlbWl0ID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgc29ja2V0LmVtaXQoZXZlbnROYW1lLCBkYXRhLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cztcblxuICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHNvY2tldCwgYXJncyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBjb25uZWN0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAvLyBjb25uZWN0IHRvIFNvY2tldC5pbyBzZXJ2ZXJcbiAgICAgICAgICAgIHNvY2tldCA9IGlvLmNvbm5lY3QoKTtcblxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJ1NvY2tldCBjb25uZWN0ZWQnKTtcblxuICAgICAgICAgICAgb24oJ2lkJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIG93bklkID0gZGF0YTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBvbigndXNlcnMudXBkYXRlJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIHBhcnNlVXNlckFycmF5KGRhdGEpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG9uKCdtc2cnLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRvcGljID0gZGF0YS50b3BpYztcblxuICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRvcGljO1xuXG4gICAgICAgICAgICAgICAgLy8gcHVibGlzaCByZWxheSBtZXNzYWdlIG9uIHJvb3Qgc2NvcGVcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QodG9waWMsIGRhdGEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHBhcnNlVXNlckFycmF5ID0gZnVuY3Rpb24oX3VzZXJzKSB7XG4gICAgICAgICAgICB1c2VycyA9IF91c2Vycy5maWx0ZXIoZnVuY3Rpb24odXNlcikge1xuICAgICAgICAgICAgICAgIHJldHVybiB1c2VyLmlkICE9PSBvd25JZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciByZWdpc3RlciA9IGZ1bmN0aW9uKHVzZXJuYW1lKSB7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdCgncmVnaXN0ZXInLCB7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWU6IHVzZXJuYW1lXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICAgICAgICBzb2NrZXQuZW1pdCgnbXNnJywgbWVzc2FnZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGZpbmRVc2VyQnlJZCA9IGZ1bmN0aW9uKGlkKSB7XG4gICAgICAgICAgICB2YXIgdXNlciA9IG51bGw7XG5cbiAgICAgICAgICAgIHVzZXJzLmZvckVhY2goZnVuY3Rpb24odSkge1xuICAgICAgICAgICAgICAgIGlmICh1LmlkID09PSBpZCkge1xuICAgICAgICAgICAgICAgICAgICB1c2VyID0gdTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIHVzZXI7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvbm5lY3Q6IGNvbm5lY3QsXG4gICAgICAgICAgICByZWdpc3RlcjogcmVnaXN0ZXIsXG4gICAgICAgICAgICBmaW5kVXNlckJ5SWQ6IGZpbmRVc2VyQnlJZCxcbiAgICAgICAgICAgIHNlbmRNZXNzYWdlOiBzZW5kTWVzc2FnZSxcbiAgICAgICAgICAgIGdldFVzZXJzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXNlcnM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSk7XG4iLCIndXNlIHN0cmljdCc7XHJcblxyXG5hbmd1bGFyLm1vZHVsZSgncGxhaW4td2VicnRjJylcclxuICAgIC5mYWN0b3J5KCdXZWJSVENTcnYnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCBMb2dTcnYsIFNvY2tldFNydikge1xyXG4gICAgICAgIHZhciBsb2NhbFN0cmVhbSA9IG51bGw7XHJcbiAgICAgICAgdmFyIHJlbW90ZVN0cmVhbSA9IG51bGw7XHJcbiAgICAgICAgdmFyIHBlZXJDb25uZWN0aW9uID0gbnVsbDtcclxuXHJcbiAgICAgICAgdmFyIHJlbW90ZVBlZXIgPSBudWxsO1xyXG5cclxuICAgICAgICAvLyBTZXJ2aWNlIGNvbmZpZ3VyYXRpb25cclxuICAgICAgICB2YXIgY29uZmlnID0ge1xyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbkNvbmZpZzoge1xyXG4gICAgICAgICAgICAgICAgLy8gZGVmYXVsdCBJQ0Ugc2VydmVyIGNvbmZpZ3VyYXRpb24sIHdpbGwgYmUgb3ZlcndyaXR0ZW4gYnkgWElSU1lTIEFQSSByZXNwb25zZVxyXG4gICAgICAgICAgICAgICAgaWNlU2VydmVyczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcInVybHNcIjogW1wic3R1bjoyMy4yMS4xNTAuMTIxXCJdfSxcclxuICAgICAgICAgICAgICAgICAgICB7XCJ1cmxzXCI6IFtcInN0dW46c3R1bi5sLmdvb2dsZS5jb206MTkzMDJcIl19LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcInVybHNcIjogW1widHVybjpudW1iLnZpYWdlbmllLmNhP3RyYW5zcG9ydD11ZHBcIl0sIFwidXNlcm5hbWVcIjogXCJtaWNoYWVsLnN0aWZ0ZXJAZXZvbGFyaXMubmV0XCIsIFwiY3JlZGVudGlhbFwiOiBcIjE1dUZidUN4YXpLck16b2cyV25NXCJ9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcInVybHNcIjogW1widHVybjpudW1iLnZpYWdlbmllLmNhP3RyYW5zcG9ydD10Y3BcIl0sIFwidXNlcm5hbWVcIjogXCJtaWNoYWVsLnN0aWZ0ZXJAZXZvbGFyaXMubmV0XCIsIFwiY3JlZGVudGlhbFwiOiBcIjE1dUZidUN4YXpLck16b2cyV25NXCJ9XHJcbiAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uQ29uc3RyYWludHM6IHtcclxuICAgICAgICAgICAgICAgIG9wdGlvbmFsOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1wiRHRsc1NydHBLZXlBZ3JlZW1lbnRcIjogdHJ1ZX1cclxuICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdXNlck1lZGlhQ29uc3RyYWludHM6IHtcclxuICAgICAgICAgICAgICAgIGF1ZGlvOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgdmlkZW86IHtcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogNDgwLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogMzYwXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbihjb25maWcucGVlckNvbm5lY3Rpb25Db25maWcsIGNvbmZpZy5wZWVyQ29ubmVjdGlvbkNvbnN0cmFpbnRzKTtcclxuXHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKFwiLS0tIHBlZXIgY29ubmVjdGlvbiBjcmVhdGVkIC0tLVwiLCBjb25maWcucGVlckNvbm5lY3Rpb25Db25maWcsIGNvbmZpZy5wZWVyQ29ubmVjdGlvbkNvbnN0cmFpbnRzKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmFkZFN0cmVhbShsb2NhbFN0cmVhbSk7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gbG9jYWwgc3RyZWFtIGFkZGVkIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25hZGRzdHJlYW0gPSBoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZDtcclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25yZW1vdmVzdHJlYW0gPSBoYW5kbGVSZW1vdGVTdHJlYW1SZW1vdmVkO1xyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5vbmljZWNvbm5lY3Rpb25zdGF0ZWNoYW5nZSA9IGhhbmRsZUljZUNvbm5lY3Rpb25TdGF0ZUNoYW5nZTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLm9uaWNlY2FuZGlkYXRlID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC5jYW5kaWRhdGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMuY2FuZGlkYXRlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNTGluZUluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW5kaWRhdGU6IGV2ZW50LmNhbmRpZGF0ZS5jYW5kaWRhdGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24ub25kYXRhY2hhbm5lbCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGRhdGEgY2hhbm5lbCByZWNlaXZlZCAtLS0nLCBldmVudC5jaGFubmVsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBvZmZlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNyZWF0aW5nIG9mZmVyIC0tLScpO1xyXG5cclxuICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uY3JlYXRlT2ZmZXIoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oc2Vzc2lvbkRlc2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVlckNvbm5lY3Rpb24uc2V0TG9jYWxEZXNjcmlwdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMub2ZmZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiBzZXNzaW9uRGVzY3JpcHRpb25cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgb2ZmZXInLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGFuc3dlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNyZWF0aW5nIGFuc3dlciAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgIHBlZXJDb25uZWN0aW9uLmNyZWF0ZUFuc3dlcigpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKHNlc3Npb25EZXNjcmlwdGlvbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIFNvY2tldFNydi5zZW5kTWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvOiByZW1vdGVQZWVyLmlkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3BpYzogJ3dlYnJ0Yy5hbnN3ZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiBzZXNzaW9uRGVzY3JpcHRpb25cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmVycm9yKCdmYWlsZWQgdG8gc2V0IGxvY2FsIGRlc2NyaXB0aW9uJywgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKFwiLS0tIHJlbW90ZSBzdHJlYW0gYWRkZWQgLS0tXCIpO1xyXG5cclxuICAgICAgICAgICAgZXZlbnQuc3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2goZnVuY3Rpb24odHJhY2spIHtcclxuICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKFwiUkVNT1RFIFNUUkVBTSBUUkFDS1wiLCB0cmFjayk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gc2F2ZSByZW1vdGUgc3RyZWFtIHJlZmVyZW5jZVxyXG4gICAgICAgICAgICByZW1vdGVTdHJlYW0gPSBldmVudC5zdHJlYW07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGhhbmRsZVJlbW90ZVN0cmVhbVJlbW92ZWQgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbyhcIi0tLSByZW1vdGUgc3RyZWFtIHJlbW92ZWQgLS0tXCIpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBoYW5kbGVJY2VDb25uZWN0aW9uU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbihldmVudCkge1xyXG4gICAgICAgICAgICB2YXIgc3RhdGUgPSAoZXZlbnQuc3JjRWxlbWVudCB8fCBldmVudC50YXJnZXQpLmljZUNvbm5lY3Rpb25TdGF0ZTsgIC8vIGJlY2F1c2Ugb2YgZGlmZmVyZW5jZXMgYmV0d2VlbiBDaHJvbWUgYW5kIEZpcmVmb3hcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoc3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Nvbm5lY3RlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBjb25uZWN0ZWQgLS0tJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnd2VicnRjLmNvbm5lY3RlZCcsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtOiByZW1vdGVTdHJlYW1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnY2xvc2VkJzpcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGNsb3NlZCAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd3ZWJydGMuZGlzY29ubmVjdGVkJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Rpc2Nvbm5lY3RlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBkaXNjb25uZWN0ZWQgLS0tJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnd2VicnRjLmRpc2Nvbm5lY3RlZCcpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjbG9zZVdlYlJUQ0Nvbm5lY3Rpb24oKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAnZmFpbGVkJzpcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuZXJyb3IoJy0tLSBmYWlsZWQgLS0tJywgZXZlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyByZWxlYXNlIG1lZGlhIGFjY2VzcyAocmV0dXJucyBhIHByb21pc2UpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVsZWFzZU1lZGlhQWNjZXNzKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSBJQ0UgY29ubmVjdGlvbiBzdGF0ZSBjaGFuZ2UgLS0tJywgc3RhdGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHJlcXVlc3RNZWRpYUFjY2VzcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICAgICAgbmF2aWdhdG9yXHJcbiAgICAgICAgICAgICAgICAgICAgLm1lZGlhRGV2aWNlc1xyXG4gICAgICAgICAgICAgICAgICAgIC5nZXRVc2VyTWVkaWEoY29uZmlnLnVzZXJNZWRpYUNvbnN0cmFpbnRzKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKG1lZGlhU3RyZWFtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RyZWFtID0gbWVkaWFTdHJlYW07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbyhcIi0tLSBnb3QgbWVkaWEgYWNjZXNzIC0tLVwiLCBjb25maWcudXNlck1lZGlhQ29uc3RyYWludHMpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShsb2NhbFN0cmVhbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1Nydi5lcnJvcignRmFpbGVkIHRvIG9idGFpbiBtZWRpYSBhY2Nlc3MgZm9yIG9wdGlvbnMnLCBjb25maWcudXNlck1lZGlhQ29uc3RyYWludHMsIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgcmVsZWFzZU1lZGlhQWNjZXNzID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgIC8vIHJlc29sdmUgcHJvbWlzZSBpbW1lZGlhdGVseSBpZiBtZWRpYSBhY2Nlc3MgaGFzIGFscmVhZHkgYmVlbiByZWxlYXNlZFxyXG4gICAgICAgICAgICAgICAgaWYgKGxvY2FsU3RyZWFtID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHZhciB0cmFja3MgPSBsb2NhbFN0cmVhbS5nZXRUcmFja3MoKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0cmFja3MuZm9yRWFjaChmdW5jdGlvbih0cmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyYWNrLnN0b3AoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGxvY2FsU3RyZWFtID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBlc3RhYmxpc2hDb25uZWN0aW9uID0gZnVuY3Rpb24ob3B0aW9ucykge1xyXG4gICAgICAgICAgICByZXF1ZXN0TWVkaWFBY2Nlc3MoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBpbml0IG1lc3NhZ2UgdG8gcmVtb3RlIHBlZXJcclxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRTcnYuc2VuZE1lc3NhZ2Uoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bzogcmVtb3RlUGVlci5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9waWM6ICd3ZWJydGMuaW5pdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW5pdCBwZWVyIGNvbm5lY3Rpb25cclxuICAgICAgICAgICAgICAgICAgICBpbml0KCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG5cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBoYW5ndXAgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKHBlZXJDb25uZWN0aW9uICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbiA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICBsb2NhbFN0cmVhbSA9IG51bGw7XHJcbiAgICAgICAgICAgIHJlbW90ZVN0cmVhbSA9IG51bGw7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGNsb3NlV2ViUlRDQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICBpZiAocGVlckNvbm5lY3Rpb24gIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gY2xvc2luZyBXZWJSVEMgY29ubmVjdGlvbiAtLS0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICByZWxlYXNlTWVkaWFBY2Nlc3MoKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5ndXAoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFJlbW90ZVBlZXIobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgc2V0UmVtb3RlUGVlciA9IGZ1bmN0aW9uKHBlZXIpIHtcclxuICAgICAgICAgICAgcmVtb3RlUGVlciA9IHBlZXI7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIGlzQ29ubmVjdGVkID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwZWVyQ29ubmVjdGlvbiAhPT0gbnVsbDtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkcm9vdFNjb3BlLiRvbignd2VicnRjLmluaXQnLCBmdW5jdGlvbihldmVudCwgZGF0YSkge1xyXG4gICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIHJlY2VpdmVkIFdlYlJUQyBpbml0IC0tLScpO1xyXG5cclxuICAgICAgICAgICAgcmVxdWVzdE1lZGlhQWNjZXNzKClcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGluaXQgcGVlciBjb25uZWN0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgaW5pdCgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIHNlc3Npb24gZGVzY3JpcHRpb24gb2ZmZXJcclxuICAgICAgICAgICAgICAgICAgICBvZmZlcigpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJHJvb3RTY29wZS4kb24oJ3dlYnJ0Yy5vZmZlcicsIGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7XHJcbiAgICAgICAgICAgIExvZ1Nydi5pbmZvKCctLS0gcmVjZWl2ZWQgb2ZmZXIgLS0tJywgZGF0YSk7XHJcblxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKGRhdGEucGF5bG9hZCkpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIHNldCByZW1vdGUgZGVzY3JpcHRpb24gLS0tJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgYW5zd2VyXHJcbiAgICAgICAgICAgICAgICAgICAgYW5zd2VyKCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5lcnJvcignZmFpbGVkIHRvIHNldCByZW1vdGUgZGVzY3JpcHRpb24nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRyb290U2NvcGUuJG9uKCd3ZWJydGMuYW5zd2VyJywgZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHtcclxuICAgICAgICAgICAgTG9nU3J2LmluZm8oJy0tLSByZWNlaXZlZCBhbnN3ZXIgLS0tJywgZGF0YSk7XHJcblxyXG4gICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKGRhdGEucGF5bG9hZCkpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIHNldCByZW1vdGUgZGVzY3JpcHRpb24gLS0tJyk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIExvZ1Nydi5lcnJvcignZmFpbGVkIHRvIHNldCByZW1vdGUgZGVzY3JpcHRpb24nLCBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRyb290U2NvcGUuJG9uKCd3ZWJydGMuY2FuZGlkYXRlJywgZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHtcclxuICAgICAgICAgICAgaWYgKHBlZXJDb25uZWN0aW9uLnJlbW90ZURlc2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBwZWVyQ29ubmVjdGlvbi5hZGRJY2VDYW5kaWRhdGUobmV3IFJUQ0ljZUNhbmRpZGF0ZShkYXRhLnBheWxvYWQpKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBMb2dTcnYuaW5mbygnLS0tIGFkZGVkIElDRSBjYW5kaWRhdGUgLS0tJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIExvZ1Nydi5lcnJvcignZmFpbGVkIHRvIGFkZCBJQ0UgY2FuZGlkYXRlJywgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBpbml0OiBpbml0LFxyXG4gICAgICAgICAgICBlc3RhYmxpc2hDb25uZWN0aW9uOiBlc3RhYmxpc2hDb25uZWN0aW9uLFxyXG4gICAgICAgICAgICBjbG9zZUNvbm5lY3Rpb246IGNsb3NlV2ViUlRDQ29ubmVjdGlvbixcclxuICAgICAgICAgICAgc2V0UmVtb3RlUGVlcjogc2V0UmVtb3RlUGVlcixcclxuICAgICAgICAgICAgaXNDb25uZWN0ZWQ6IGlzQ29ubmVjdGVkXHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
